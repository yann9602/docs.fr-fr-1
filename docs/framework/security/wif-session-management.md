---
title: Gestion de session WIF
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net-framework
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-clr
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: 98bce126-18a9-401b-b20d-67ee462a5f8a
caps.latest.revision: "7"
author: BrucePerlerMS
ms.author: bruceper
manager: mbaldwin
ms.openlocfilehash: 9c41b9c0c9abe3fc80d16dbd847c35c8b2da7038
ms.sourcegitcommit: bd1ef61f4bb794b25383d3d72e71041a5ced172e
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 10/18/2017
---
# <a name="wif-session-management"></a><span data-ttu-id="6a582-102">Gestion de session WIF</span><span class="sxs-lookup"><span data-stu-id="6a582-102">WIF Session Management</span></span>
<span data-ttu-id="6a582-103">Quand un client tente d’abord d’accéder à une ressource protégée qui est hébergée par une partie de confiance, il doit d’abord s’authentifier auprès d’un service d’émission de jeton de sécurité (STS) qui est approuvé par la partie de confiance.</span><span class="sxs-lookup"><span data-stu-id="6a582-103">When a client first tries to access a protected resource that is hosted by a relying party, the client must first authenticate itself to a security token service (STS) that is trusted by the relying party.</span></span> <span data-ttu-id="6a582-104">Le service STS fournit ensuite un jeton de sécurité au client.</span><span class="sxs-lookup"><span data-stu-id="6a582-104">The STS then issues a security token to the client.</span></span> <span data-ttu-id="6a582-105">Le client présente ce jeton à la partie de confiance, qui accorde l’accès client à la ressource protégée.</span><span class="sxs-lookup"><span data-stu-id="6a582-105">The client presents this token to the relying party, which then grants the client access to the protected resource.</span></span> <span data-ttu-id="6a582-106">Toutefois, vous souhaitez éviter au client d’avoir à s’authentifier de nouveau auprès du service STS pour chaque demande, en particulier car il peut même ne pas se trouver sur le même ordinateur ou dans le même domaine que la partie de confiance.</span><span class="sxs-lookup"><span data-stu-id="6a582-106">However, you don’t want the client to have to re-authenticate to the STS for each request, especially because it might not even be on the same computer or in the same domain as the relying party.</span></span> <span data-ttu-id="6a582-107">Au lieu de cela, avec WIF (Windows Identity Foundation), le client et la partie de confiance établissent une session dans laquelle le client utilise un jeton de sécurité de session pour s’authentifier auprès de la partie de confiance pour toutes les demandes après la première.</span><span class="sxs-lookup"><span data-stu-id="6a582-107">Instead, Windows Identity Foundation (WIF) has the client and relying party establish a session in which the client uses a session security token to authenticate itself to the relying party for all requests after the first request.</span></span> <span data-ttu-id="6a582-108">La partie de confiance peut utiliser ce jeton de sécurité de session, qui est stocké à l’intérieur d’un cookie, afin de reconstruire le <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType> du client.</span><span class="sxs-lookup"><span data-stu-id="6a582-108">The relying party can use this session security token, which is stored inside a cookie, to reconstruct the client’s <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType>.</span></span>  
  
 <span data-ttu-id="6a582-109">Le service STS définit l’authentification que le client doit fournir.</span><span class="sxs-lookup"><span data-stu-id="6a582-109">The STS defines what authentication the client must provide.</span></span> <span data-ttu-id="6a582-110">Toutefois, le client peut avoir plusieurs informations d’identification avec lesquelles il peut s’authentifier auprès du service STS.</span><span class="sxs-lookup"><span data-stu-id="6a582-110">However, the client might have multiple credentials with which it can authenticate itself to the STS.</span></span> <span data-ttu-id="6a582-111">Par exemple, il peut avoir un jeton Windows Live, un nom d’utilisateur et un mot de passe, un certificat, et un smartkey.</span><span class="sxs-lookup"><span data-stu-id="6a582-111">For example, it might have a token from Windows Live, a user name and password, a certificate, and a smartkey.</span></span> <span data-ttu-id="6a582-112">Dans ce cas, le service STS accorde au client plusieurs identités, chacune correspondant à l’une des informations d’identification que le client présente.</span><span class="sxs-lookup"><span data-stu-id="6a582-112">In that case, the STS grants the client several identities, with each identity corresponding to one of the credentials that the client presents.</span></span> <span data-ttu-id="6a582-113">La partie de confiance peut utiliser une ou plusieurs de ces identités quand elle décide du niveau d’accès à accorder au client.</span><span class="sxs-lookup"><span data-stu-id="6a582-113">The relying party can use one or more of these identities when it decides what level of access to grant the client.</span></span>  
  
 <span data-ttu-id="6a582-114"><xref:System.IdentityModel.Tokens.SessionSecurityToken?displayProperty=nameWithType> est utilisé pour reconstruire le <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType> du client, qui contient toutes les identités du client dans <xref:System.Security.Claims.ClaimsPrincipal.Identities%2A>.</span><span class="sxs-lookup"><span data-stu-id="6a582-114">The <xref:System.IdentityModel.Tokens.SessionSecurityToken?displayProperty=nameWithType> is used to reconstruct the client’s <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType>, which contains all of the client’s identities in <xref:System.Security.Claims.ClaimsPrincipal.Identities%2A>.</span></span> <span data-ttu-id="6a582-115">Chaque <xref:System.Security.Claims.ClaimsIdentity?displayProperty=nameWithType> dans la collection contient les jetons de démarrage qui sont associés à cette identité.</span><span class="sxs-lookup"><span data-stu-id="6a582-115">Each <xref:System.Security.Claims.ClaimsIdentity?displayProperty=nameWithType> in the collection contains the bootstrap tokens that are associated with that identity.</span></span>  
  
 <span data-ttu-id="6a582-116">Si un nouveau jeton de session est émis avec l’ID de session du jeton de session d’origine, <xref:System.IdentityModel.Tokens.SessionSecurityTokenHandler?displayProperty=nameWithType> ne met pas à jour le jeton de session dans le cache de jeton.</span><span class="sxs-lookup"><span data-stu-id="6a582-116">If a new session token is issued with the session ID of the original session token, <xref:System.IdentityModel.Tokens.SessionSecurityTokenHandler?displayProperty=nameWithType> does not update the session token in the token cache.</span></span> <span data-ttu-id="6a582-117">Vous devez toujours instancier un jeton de session avec un ID de session unique.</span><span class="sxs-lookup"><span data-stu-id="6a582-117">You should always instantiate a session token with a unique session ID.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="6a582-118">Session.SecurityTokenHandler.ReadToken lève une exception <xref:System.Xml.XmlException> s’il reçoit une entrée non valide, par exemple si le cookie qui contient le jeton de session est endommagé.</span><span class="sxs-lookup"><span data-stu-id="6a582-118">Session.SecurityTokenHandler.ReadToken throws a <xref:System.Xml.XmlException> exception if it receives invalid input; for example, if the cookie that contains the session token is corrupted.</span></span> <span data-ttu-id="6a582-119">Nous vous recommandons d’intercepter cette exception et de fournir un comportement spécifique à l’application.</span><span class="sxs-lookup"><span data-stu-id="6a582-119">We recommend that you catch this exception and provide application-specific behavior.</span></span>  
  
 <span data-ttu-id="6a582-120">Si une page web protégée contient un grand nombre de ressources (telles que des petits graphiques) qui figurent également dans le domaine protégé, le client doit s’authentifier de nouveau auprès de la partie de confiance pour télécharger chacune de ces ressources.</span><span class="sxs-lookup"><span data-stu-id="6a582-120">If a protected Web page contains lots of resources (such as small graphics) that are also in the protected domain, the client must re-authenticate itself to the relying party to download each of those resources.</span></span> <span data-ttu-id="6a582-121">L’utilisation d’un jeton d’authentification de session évite d’avoir à s’authentifier auprès du service STS pour chaque demande, mais signifie néanmoins que de nombreux cookies sont envoyés.</span><span class="sxs-lookup"><span data-stu-id="6a582-121">Use of a session authentication token avoids the need to authenticate to the STS for each request, but it still means that many cookies are being sent over.</span></span> <span data-ttu-id="6a582-122">Vous pouvez configurer la page web afin que les données et les ressources importantes soient stockées dans le domaine protégé, alors que les éléments secondaires sont stockés dans un domaine non protégé et liés à la page web principale.</span><span class="sxs-lookup"><span data-stu-id="6a582-122">You might want to set up the Web page so that the important data and resources are stored in the protected domain while minor items are stored in an unprotected domain and linked to from the main Web page.</span></span> <span data-ttu-id="6a582-123">Définissez également le chemin du cookie pour référencer uniquement le domaine protégé.</span><span class="sxs-lookup"><span data-stu-id="6a582-123">Also, set the cookie path to reference only the protected domain.</span></span>  
  
 <span data-ttu-id="6a582-124">Pour fonctionner en mode de référence, Microsoft recommande de fournir un gestionnaire pour l’événement <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SessionSecurityTokenCreated> dans le fichier **global.asax.cs** et de définir la propriété **IsReferenceMode** sur le jeton passé dans la propriété <xref:System.IdentityModel.Services.SessionSecurityTokenCreatedEventArgs.SessionToken%2A>.</span><span class="sxs-lookup"><span data-stu-id="6a582-124">To operate in reference mode, Microsoft recommends providing a handler for the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SessionSecurityTokenCreated> event in the **global.asax.cs** file and setting the **IsReferenceMode** property on the token passed in the <xref:System.IdentityModel.Services.SessionSecurityTokenCreatedEventArgs.SessionToken%2A> property.</span></span> <span data-ttu-id="6a582-125">Ces mises à jour garantissent que le jeton de session fonctionne en mode de référence pour chaque demande et est privilégié par rapport à une simple définition de la propriété <xref:System.IdentityModel.Services.SessionAuthenticationModule.IsReferenceMode%2A> sur le module d’authentification de session.</span><span class="sxs-lookup"><span data-stu-id="6a582-125">These updates will ensure that the session token operates in reference mode for every request and is favored over merely setting the  <xref:System.IdentityModel.Services.SessionAuthenticationModule.IsReferenceMode%2A> property on the Session Authentication Module.</span></span>  
  
## <a name="extensibility"></a><span data-ttu-id="6a582-126">Extensibilité</span><span class="sxs-lookup"><span data-stu-id="6a582-126">Extensibility</span></span>  
 <span data-ttu-id="6a582-127">Vous pouvez étendre le mécanisme de gestion de session,</span><span class="sxs-lookup"><span data-stu-id="6a582-127">You can extend the session management mechanism.</span></span> <span data-ttu-id="6a582-128">par exemple dans le but d’améliorer les performances.</span><span class="sxs-lookup"><span data-stu-id="6a582-128">One reason for this would be to improve the performance.</span></span> <span data-ttu-id="6a582-129">Vous pouvez notamment créer un gestionnaire de cookie personnalisé qui transforme ou optimise le jeton de sécurité de session entre son état en mémoire et ce qui entre dans le cookie.</span><span class="sxs-lookup"><span data-stu-id="6a582-129">For example, you could create a custom cookie handler that transforms or optimizes the session security token between its in-memory state and what goes into the cookie.</span></span> <span data-ttu-id="6a582-130">Pour ce faire, vous pouvez configurer la propriété <xref:System.IdentityModel.Services.SessionAuthenticationModule.CookieHandler%2A?displayProperty=nameWithType> de <xref:System.IdentityModel.Services.SessionAuthenticationModule?displayProperty=nameWithType> pour utiliser un gestionnaire de cookie personnalisé qui dérive de <xref:System.IdentityModel.Services.CookieHandler?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="6a582-130">To do so, you can configure the <xref:System.IdentityModel.Services.SessionAuthenticationModule.CookieHandler%2A?displayProperty=nameWithType> property of the <xref:System.IdentityModel.Services.SessionAuthenticationModule?displayProperty=nameWithType> to use a custom cookie handler that derives from <xref:System.IdentityModel.Services.CookieHandler?displayProperty=nameWithType>.</span></span> <span data-ttu-id="6a582-131"><xref:System.IdentityModel.Services.ChunkedCookieHandler?displayProperty=nameWithType> est le gestionnaire de cookie par défaut, car les cookies dépassent la taille autorisée pour le protocole HTTP (Hypertext Transfer Protocol) ; si vous utilisez plutôt un gestionnaire de cookie personnalisé, vous devez implémenter la segmentation.</span><span class="sxs-lookup"><span data-stu-id="6a582-131"><xref:System.IdentityModel.Services.ChunkedCookieHandler?displayProperty=nameWithType> is the default cookie handler because the cookies exceed the allowable size for Hypertext Transfer Protocol (HTTP); if you use a custom cookie handler instead, you must implement chunking.</span></span>  
  
 <span data-ttu-id="6a582-132">Pour plus d’informations, consultez l’exemple [ClaimsAwareWebFarm](http://go.microsoft.com/fwlink/?LinkID=248408) (http://go.microsoft.com/fwlink/?LinkID=248408).</span><span class="sxs-lookup"><span data-stu-id="6a582-132">For more information, see [ClaimsAwareWebFarm](http://go.microsoft.com/fwlink/?LinkID=248408) (http://go.microsoft.com/fwlink/?LinkID=248408) sample.</span></span> <span data-ttu-id="6a582-133">Cet exemple montre un cache de sessions prêt pour une batterie de serveurs (par opposition à un tokenreplycache) afin que vous puissiez utiliser des sessions par référence au lieu d’échanger des cookies de grande taille. Cet exemple illustre également un moyen plus simple de sécuriser des cookies dans une batterie de serveurs.</span><span class="sxs-lookup"><span data-stu-id="6a582-133">This sample shows a farm ready session cache (as opposed to a tokenreplycache) so that you can use sessions by reference instead of exchanging big cookies; this sample also demonstrates an easier way of securing cookies in a farm.</span></span> <span data-ttu-id="6a582-134">Le cache de sessions est basé sur WCF.</span><span class="sxs-lookup"><span data-stu-id="6a582-134">The session cache is WCF-based.</span></span> <span data-ttu-id="6a582-135">En ce qui concerne la sécurisation de session, l’exemple illustre une nouvelle fonction dans WIF 4.5 d’une transformation de cookie basée sur MachineKey, qui peut être activée en collant simplement l’extrait approprié dans le fichier web.config. L’exemple lui-même n’est pas « en batterie de serveurs », mais il montre ce dont vous avez besoin pour que votre application soit prête pour une batterie de serveurs.</span><span class="sxs-lookup"><span data-stu-id="6a582-135">With regard to session securing, the sample demonstrates a new capability in WIF 4.5 of a cookie transform based on MachineKey, which can be activated by simply pasting the appropriate snippet in the web.config. The sample itself is not "farmed", but it demonstrates what you need for making your app farm-ready.</span></span>
