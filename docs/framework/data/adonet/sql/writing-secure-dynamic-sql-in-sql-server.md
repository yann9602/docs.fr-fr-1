---
title: "Écriture de Dynamic SQL sécurisé dans SQL Server"
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net-framework
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-ado
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: df5512b0-c249-40d2-82f9-f9a2ce6665bc
caps.latest.revision: "9"
author: douglaslMS
ms.author: douglasl
manager: craigg
ms.workload: dotnet
ms.openlocfilehash: 41c396bf2101e54adb1608f938c702ff7663cb1d
ms.sourcegitcommit: ed26cfef4e18f6d93ab822d8c29f902cff3519d1
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/17/2018
---
# <a name="writing-secure-dynamic-sql-in-sql-server"></a><span data-ttu-id="e020b-102">Écriture de Dynamic SQL sécurisé dans SQL Server</span><span class="sxs-lookup"><span data-stu-id="e020b-102">Writing Secure Dynamic SQL in SQL Server</span></span>
<span data-ttu-id="e020b-103">L'injection SQL est le processus qui permet à un utilisateur malveillant d'entrer des instructions Transact-SQL au lieu d'une entrée valide.</span><span class="sxs-lookup"><span data-stu-id="e020b-103">SQL Injection is the process by which a malicious user enters Transact-SQL statements instead of valid input.</span></span> <span data-ttu-id="e020b-104">Si l'entrée est transmise directement au serveur sans validation et si l'application exécute accidentellement le code injecté, l'attaque risque d'endommager ou de détruire des données.</span><span class="sxs-lookup"><span data-stu-id="e020b-104">If the input is passed directly to the server without being validated and if the application inadvertently executes the injected code, the attack has the potential to damage or destroy data.</span></span>  
  
 <span data-ttu-id="e020b-105">Il est nécessaire de vérifier les vulnérabilités en matière d'injection de toute procédure qui construit des instructions SQL car SQL Server exécutera toutes les requêtes syntaxiquement valides qu'il reçoit.</span><span class="sxs-lookup"><span data-stu-id="e020b-105">Any procedure that constructs SQL statements should be reviewed for injection vulnerabilities because SQL Server will execute all syntactically valid queries that it receives.</span></span> <span data-ttu-id="e020b-106">Même les données paramétrées peuvent être manipulées par un pirate expérimenté et déterminé.</span><span class="sxs-lookup"><span data-stu-id="e020b-106">Even parameterized data can be manipulated by a skilled and determined attacker.</span></span> <span data-ttu-id="e020b-107">Si vous utilisez du code SQL dynamique, veillez à paramétrer vos commandes et n'incluez jamais de valeurs de paramètre directement dans la chaîne de requête.</span><span class="sxs-lookup"><span data-stu-id="e020b-107">If you use dynamic SQL, be sure to parameterize your commands, and never include parameter values directly into the query string.</span></span>  
  
## <a name="anatomy-of-a-sql-injection-attack"></a><span data-ttu-id="e020b-108">Anatomie d'une attaque par injection de code SQL</span><span class="sxs-lookup"><span data-stu-id="e020b-108">Anatomy of a SQL Injection Attack</span></span>  
 <span data-ttu-id="e020b-109">Le processus d'injection consiste à terminer prématurément une chaîne de texte et à ajouter une nouvelle commande.</span><span class="sxs-lookup"><span data-stu-id="e020b-109">The injection process works by prematurely terminating a text string and appending a new command.</span></span> <span data-ttu-id="e020b-110">Dans la mesure où des chaînes supplémentaires peuvent être ajoutées à la commande insérée avant son exécution, le pirate termine la chaîne injectée avec une marque de commentaire "--".</span><span class="sxs-lookup"><span data-stu-id="e020b-110">Because the inserted command may have additional strings appended to it before it is executed, the malefactor terminates the injected string with a comment mark "--".</span></span> <span data-ttu-id="e020b-111">Le texte qui suit est ignoré au moment de l'exécution.</span><span class="sxs-lookup"><span data-stu-id="e020b-111">Subsequent text is ignored at execution time.</span></span> <span data-ttu-id="e020b-112">Plusieurs commandes peuvent être insérées en utilisant le séparateur point-virgule (;).</span><span class="sxs-lookup"><span data-stu-id="e020b-112">Multiple commands can be inserted using a semicolon (;) delimiter.</span></span>  
  
 <span data-ttu-id="e020b-113">Tant que le code SQL injecté en syntaxiquement correct, la falsification ne peut pas être détectée par programme.</span><span class="sxs-lookup"><span data-stu-id="e020b-113">As long as injected SQL code is syntactically correct, tampering cannot be detected programmatically.</span></span> <span data-ttu-id="e020b-114">Vous devez par conséquent valider toutes les entrées d'utilisateur et revoir avec soin le code qui exécute des commandes SQL construites sur le serveur que vous utilisez.</span><span class="sxs-lookup"><span data-stu-id="e020b-114">Therefore, you must validate all user input and carefully review code that executes constructed SQL commands in the server that you are using.</span></span> <span data-ttu-id="e020b-115">Ne concaténez jamais des entrées d'utilisateur qui ne sont pas validées.</span><span class="sxs-lookup"><span data-stu-id="e020b-115">Never concatenate user input that is not validated.</span></span> <span data-ttu-id="e020b-116">La concaténation de chaînes est le principal point d'entrée pour l'injection de script.</span><span class="sxs-lookup"><span data-stu-id="e020b-116">String concatenation is the primary point of entry for script injection.</span></span>  
  
 <span data-ttu-id="e020b-117">Voici quelques conseils utiles :</span><span class="sxs-lookup"><span data-stu-id="e020b-117">Here are some helpful guidelines:</span></span>  
  
-   <span data-ttu-id="e020b-118">Ne générez jamais des instructions Transact-SQL directement à partir d'entrées d'utilisateur. Utilisez des procédures stockées pour valider les entrées d'utilisateur.</span><span class="sxs-lookup"><span data-stu-id="e020b-118">Never build Transact-SQL statements directly from user input; use stored procedures to validate user input.</span></span>  
  
-   <span data-ttu-id="e020b-119">Validez les entrées d'utilisateur en testant le type, la longueur, le format et la plage.</span><span class="sxs-lookup"><span data-stu-id="e020b-119">Validate user input by testing type, length, format, and range.</span></span> <span data-ttu-id="e020b-120">Utilisez la fonction Transact-SQL QUOTENAME() pour échapper les noms système ou la fonction REPLACE() pour échapper tout caractère d'une chaîne.</span><span class="sxs-lookup"><span data-stu-id="e020b-120">Use the Transact-SQL QUOTENAME() function to escape system names or the REPLACE() function to escape any character in a string.</span></span>  
  
-   <span data-ttu-id="e020b-121">Implémentez plusieurs couches de validation dans chaque niveau de votre application.</span><span class="sxs-lookup"><span data-stu-id="e020b-121">Implement multiple layers of validation in each tier of your application.</span></span>  
  
-   <span data-ttu-id="e020b-122">Testez la taille et le type de données des entrées et appliquez des limites appropriées.</span><span class="sxs-lookup"><span data-stu-id="e020b-122">Test the size and data type of input and enforce appropriate limits.</span></span> <span data-ttu-id="e020b-123">Cela permet d'éviter les dépassements délibérés de mémoire tampon.</span><span class="sxs-lookup"><span data-stu-id="e020b-123">This can help prevent deliberate buffer overruns.</span></span>  
  
-   <span data-ttu-id="e020b-124">Testez le contenu des variables de chaîne et acceptez uniquement les valeurs attendues.</span><span class="sxs-lookup"><span data-stu-id="e020b-124">Test the content of string variables and accept only expected values.</span></span> <span data-ttu-id="e020b-125">Rejetez les entrées qui contiennent des données binaires, des séquences d'échappement et des caractères de commentaire.</span><span class="sxs-lookup"><span data-stu-id="e020b-125">Reject entries that contain binary data, escape sequences, and comment characters.</span></span>  
  
-   <span data-ttu-id="e020b-126">Lorsque vous travaillez avec des documents XML, validez toutes les données par rapport à leur schéma tel qu'il est entré.</span><span class="sxs-lookup"><span data-stu-id="e020b-126">When you are working with XML documents, validate all data against its schema as it is entered.</span></span>  
  
-   <span data-ttu-id="e020b-127">Dans les environnements multicouches, toutes les données doivent être validées avant admission dans la zone de confiance.</span><span class="sxs-lookup"><span data-stu-id="e020b-127">In multi-tiered environments, all data should be validated before admission to the trusted zone.</span></span>  
  
-   <span data-ttu-id="e020b-128">N'acceptez pas les chaînes suivantes dans les champs à partir desquels les noms de fichiers peuvent être construits : AUX, CLOCK$, COM1 à COM8, CON, CONFIG$, LPT1 à LPT8, NUL et PRN.</span><span class="sxs-lookup"><span data-stu-id="e020b-128">Do not accept the following strings in fields from which file names can be constructed: AUX, CLOCK$, COM1 through COM8, CON, CONFIG$, LPT1 through LPT8, NUL, and PRN.</span></span>  
  
-   <span data-ttu-id="e020b-129">Utilisez des objets <xref:System.Data.SqlClient.SqlParameter>  avec des procédures stockées et des commandes pour fournir le contrôle de type et la validation de longueur.</span><span class="sxs-lookup"><span data-stu-id="e020b-129">Use <xref:System.Data.SqlClient.SqlParameter> objects with stored procedures and commands to provide type checking and length validation.</span></span>  
  
-   <span data-ttu-id="e020b-130">Utilisez des expressions <xref:System.Text.RegularExpressions.Regex> pour filtrer les caractères non valides.</span><span class="sxs-lookup"><span data-stu-id="e020b-130">Use <xref:System.Text.RegularExpressions.Regex> expressions in client code to filter invalid characters.</span></span>  
  
## <a name="dynamic-sql-strategies"></a><span data-ttu-id="e020b-131">Stratégies SQL dynamique</span><span class="sxs-lookup"><span data-stu-id="e020b-131">Dynamic SQL Strategies</span></span>  
 <span data-ttu-id="e020b-132">L'exécution d'instructions SQL créées de manière dynamique dans votre code de procédure rompt la chaîne de propriétés, ce qui conduit SQL Server à vérifier les autorisations de l'appelant par rapport aux objets auxquels le code SQL dynamique accède.</span><span class="sxs-lookup"><span data-stu-id="e020b-132">Executing dynamically created SQL statements in your procedural code breaks the ownership chain, causing SQL Server to check the permissions of the caller against the objects being accessed by the dynamic SQL.</span></span>  
  
 <span data-ttu-id="e020b-133">SQL Server dispose de méthodes pour accorder aux utilisateurs l'accès aux données à l'aide de procédures stockées et de fonctions définies par l'utilisateur qui exécutent du code SQL dynamique.</span><span class="sxs-lookup"><span data-stu-id="e020b-133">SQL Server has methods for granting users access to data using stored procedures and user-defined functions that execute dynamic SQL.</span></span>  
  
-   <span data-ttu-id="e020b-134">À l’aide de l’emprunt d’identité avec Transact-SQL EXECUTE AS clause, comme décrit dans [personnalisation des autorisations avec emprunt d’identité dans SQL Server](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="e020b-134">Using impersonation with the Transact-SQL EXECUTE AS clause, as described in [Customizing Permissions with Impersonation in SQL Server](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md).</span></span>  
  
-   <span data-ttu-id="e020b-135">Signature de procédures stockées avec des certificats, comme décrit dans [de signature de procédures stockées dans SQL Server](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="e020b-135">Signing stored procedures with certificates, as described in [Signing Stored Procedures in SQL Server](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md).</span></span>  
  
### <a name="execute-as"></a><span data-ttu-id="e020b-136">EXECUTE AS</span><span class="sxs-lookup"><span data-stu-id="e020b-136">EXECUTE AS</span></span>  
 <span data-ttu-id="e020b-137">La clause EXECUTE AS remplace les autorisations de l'appelant par celles de l'utilisateur spécifié dans la clause EXECUTE AS.</span><span class="sxs-lookup"><span data-stu-id="e020b-137">The EXECUTE AS clause replaces the permissions of the caller with that of the user specified in the EXECUTE AS clause.</span></span> <span data-ttu-id="e020b-138">Les procédures stockées ou déclencheurs imbriqués s'exécutent dans le contexte de sécurité de l'utilisateur proxy.</span><span class="sxs-lookup"><span data-stu-id="e020b-138">Nested stored procedures or triggers execute under the security context of the proxy user.</span></span> <span data-ttu-id="e020b-139">Les applications qui reposent sur la sécurité de niveau ligne ou qui nécessitent un audit risquent alors de s'arrêter.</span><span class="sxs-lookup"><span data-stu-id="e020b-139">This can break applications that rely on row-level security or require auditing.</span></span> <span data-ttu-id="e020b-140">Certaines fonctions qui retournent l'identité de l'utilisateur retournent l'utilisateur spécifié dans la clause EXECUTE AS, et non l'appelant d'origine.</span><span class="sxs-lookup"><span data-stu-id="e020b-140">Some functions that return the identity of the user return the user specified in the EXECUTE AS clause, not the original caller.</span></span> <span data-ttu-id="e020b-141">Le contexte d'exécution de l'appelant d'origine est rétabli uniquement après exécution de la procédure ou lorsqu'une instruction REVERT est émise.</span><span class="sxs-lookup"><span data-stu-id="e020b-141">Execution context is reverted to the original caller only after execution of the procedure or when a REVERT statement is issued.</span></span>  
  
### <a name="certificate-signing"></a><span data-ttu-id="e020b-142">Signature par certificat</span><span class="sxs-lookup"><span data-stu-id="e020b-142">Certificate Signing</span></span>  
 <span data-ttu-id="e020b-143">Lors de l'exécution d'une procédure stockée qui a été signée avec un certificat, les autorisations accordées à l'utilisateur de ce certificat sont fusionnées avec celles de l'appelant.</span><span class="sxs-lookup"><span data-stu-id="e020b-143">When a stored procedure that has been signed with a certificate executes, the permissions granted to the certificate user are merged with those of the caller.</span></span> <span data-ttu-id="e020b-144">Le contexte d'exécution reste le même ; l'utilisateur du certificat n'emprunte pas l'identité de l'appelant.</span><span class="sxs-lookup"><span data-stu-id="e020b-144">The execution context remains the same; the certificate user does not impersonate the caller.</span></span> <span data-ttu-id="e020b-145">Plusieurs étapes sont nécessaires pour implémenter la signature des procédures stockées.</span><span class="sxs-lookup"><span data-stu-id="e020b-145">Signing stored procedures requires several steps to implement.</span></span> <span data-ttu-id="e020b-146">La procédure doit être de nouveau signée après chaque modification.</span><span class="sxs-lookup"><span data-stu-id="e020b-146">Each time the procedure is modified, it must be re-signed.</span></span>  
  
### <a name="cross-database-access"></a><span data-ttu-id="e020b-147">Accès aux bases de données croisées</span><span class="sxs-lookup"><span data-stu-id="e020b-147">Cross Database Access</span></span>  
 <span data-ttu-id="e020b-148">Le chaînage des propriétés des bases de données croisées ne fonctionne pas en cas d'exécution d'instructions SQL créées de manière dynamique.</span><span class="sxs-lookup"><span data-stu-id="e020b-148">Cross-database ownership chaining does not work in cases where dynamically created SQL statements are executed.</span></span> <span data-ttu-id="e020b-149">Il est possible de contourner cette restriction dans [!INCLUDE[ssNoVersion](../../../../../includes/ssnoversion-md.md)] en créant une procédure stockée qui accède aux données dans une autre base de données et en signant la procédure avec un certificat qui existe dans les deux bases de données.</span><span class="sxs-lookup"><span data-stu-id="e020b-149">You can work around this in [!INCLUDE[ssNoVersion](../../../../../includes/ssnoversion-md.md)] by creating a stored procedure that accesses data in another database and signing the procedure with a certificate that exists in both databases.</span></span> <span data-ttu-id="e020b-150">De cette manière, les utilisateurs ont accès aux ressources de base de données utilisées par la procédure sans que l'accès ou les autorisations de base de données leur soient octroyés.</span><span class="sxs-lookup"><span data-stu-id="e020b-150">This gives users access to the database resources used by the procedure without granting them database access or permissions.</span></span>  
  
## <a name="external-resources"></a><span data-ttu-id="e020b-151">Ressources externes</span><span class="sxs-lookup"><span data-stu-id="e020b-151">External Resources</span></span>  
 <span data-ttu-id="e020b-152">Pour plus d'informations, voir les ressources ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="e020b-152">For more information, see the following resources.</span></span>  
  
|<span data-ttu-id="e020b-153">Ressource</span><span class="sxs-lookup"><span data-stu-id="e020b-153">Resource</span></span>|<span data-ttu-id="e020b-154">Description</span><span class="sxs-lookup"><span data-stu-id="e020b-154">Description</span></span>|  
|--------------|-----------------|  
|<span data-ttu-id="e020b-155">[Procédures stockées](http://go.microsoft.com/fwlink/?LinkId=98233) et [Injection SQL](http://go.microsoft.com/fwlink/?LinkId=98234) dans la documentation en ligne de SQL Server</span><span class="sxs-lookup"><span data-stu-id="e020b-155">[Stored Procedures](http://go.microsoft.com/fwlink/?LinkId=98233) and [SQL Injection](http://go.microsoft.com/fwlink/?LinkId=98234) in SQL Server Books Online</span></span>|<span data-ttu-id="e020b-156">Ces rubriques expliquent comment créer des procédures stockées et comment fonctionne l'injection SQL.</span><span class="sxs-lookup"><span data-stu-id="e020b-156">Topics describe how to create stored procedures and how SQL Injection works.</span></span>|  
|<span data-ttu-id="e020b-157">[Nouvelles attaques par troncature de SQL et comment les éviter](http://msdn.microsoft.com/msdnmag/issues/06/11/SQLSecurity/) dans MSDN Magazine.</span><span class="sxs-lookup"><span data-stu-id="e020b-157">[New SQL Truncation Attacks And How To Avoid Them](http://msdn.microsoft.com/msdnmag/issues/06/11/SQLSecurity/) in MSDN Magazine.</span></span>|<span data-ttu-id="e020b-158">Décrit comment délimiter des caractères et des chaînes, présente l'injection SQL et décrit la modification par des attaques par troncation.</span><span class="sxs-lookup"><span data-stu-id="e020b-158">Describes how to delimit characters and strings, SQL injection, and modification by  truncation attacks.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="e020b-159">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="e020b-159">See Also</span></span>  
 [<span data-ttu-id="e020b-160">Sécurisation des applications ADO.NET</span><span class="sxs-lookup"><span data-stu-id="e020b-160">Securing ADO.NET Applications</span></span>](../../../../../docs/framework/data/adonet/securing-ado-net-applications.md)  
 [<span data-ttu-id="e020b-161">Vue d’ensemble de la sécurité SQL Server</span><span class="sxs-lookup"><span data-stu-id="e020b-161">Overview of SQL Server Security</span></span>](../../../../../docs/framework/data/adonet/sql/overview-of-sql-server-security.md)  
 [<span data-ttu-id="e020b-162">Scénarios de sécurité des applications dans SQL Server</span><span class="sxs-lookup"><span data-stu-id="e020b-162">Application Security Scenarios in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/application-security-scenarios-in-sql-server.md)  
 [<span data-ttu-id="e020b-163">Gestion des autorisations avec les procédures stockées dans SQL Server</span><span class="sxs-lookup"><span data-stu-id="e020b-163">Managing Permissions with Stored Procedures in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/managing-permissions-with-stored-procedures-in-sql-server.md)  
 [<span data-ttu-id="e020b-164">Signature de procédures stockées dans SQL Server</span><span class="sxs-lookup"><span data-stu-id="e020b-164">Signing Stored Procedures in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/signing-stored-procedures-in-sql-server.md)  
 [<span data-ttu-id="e020b-165">Personnalisation des autorisations avec l’emprunt d’identité dans SQL Server</span><span class="sxs-lookup"><span data-stu-id="e020b-165">Customizing Permissions with Impersonation in SQL Server</span></span>](../../../../../docs/framework/data/adonet/sql/customizing-permissions-with-impersonation-in-sql-server.md)  
 [<span data-ttu-id="e020b-166">Fournisseurs managés ADO.NET et centre de développement DataSet</span><span class="sxs-lookup"><span data-stu-id="e020b-166">ADO.NET Managed Providers and DataSet Developer Center</span></span>](http://go.microsoft.com/fwlink/?LinkId=217917)
