---
title: "Mises à niveau de flux personnalisées"
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net-framework
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-clr
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: e3da85c8-57f3-4e32-a4cb-50123f30fea6
caps.latest.revision: "10"
author: dotnet-bot
ms.author: dotnetcontent
manager: wpickett
ms.workload: dotnet
ms.openlocfilehash: 73359c293f7d29c16702e826ed6caa61149935bd
ms.sourcegitcommit: 16186c34a957fdd52e5db7294f291f7530ac9d24
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 12/22/2017
---
# <a name="custom-stream-upgrades"></a><span data-ttu-id="1287c-102">Mises à niveau de flux personnalisées</span><span class="sxs-lookup"><span data-stu-id="1287c-102">Custom Stream Upgrades</span></span>
<span data-ttu-id="1287c-103">Les transports orientés flux, tels que TCP et Canaux nommés, fonctionnent sur un flux continu d'octets entre le client et le serveur.</span><span class="sxs-lookup"><span data-stu-id="1287c-103">Stream-oriented transports such as TCP and Named Pipes operate on a continuous stream of bytes between the client and server.</span></span> <span data-ttu-id="1287c-104">Ce flux est réalisé par un objet <xref:System.IO.Stream>.</span><span class="sxs-lookup"><span data-stu-id="1287c-104">This stream is realized by a  <xref:System.IO.Stream> object.</span></span> <span data-ttu-id="1287c-105">Dans une mise à niveau de flux, le client souhaite ajouter une couche de protocole facultative à la pile de canaux et demande à l'autre extrémité du canal de communication de le faire.</span><span class="sxs-lookup"><span data-stu-id="1287c-105">In a stream upgrade, the client wants to add an optional protocol layer to the channel stack, and asks the other end of the communication channel to do so.</span></span> <span data-ttu-id="1287c-106">La mise à niveau de flux consiste à remplacer l'objet <xref:System.IO.Stream> d'origine par une version mise à niveau.</span><span class="sxs-lookup"><span data-stu-id="1287c-106">The stream upgrade consists in replacing the original <xref:System.IO.Stream> object with an upgraded one.</span></span>  
  
 <span data-ttu-id="1287c-107">Par exemple, vous pouvez générer un flux de compression directement sur le flux de transport.</span><span class="sxs-lookup"><span data-stu-id="1287c-107">For example, you can build a compression stream directly on top of the transport stream.</span></span> <span data-ttu-id="1287c-108">Dans ce cas, le <xref:System.IO.Stream> de transport d'origine est remplacé par un flux qui encapsule le <xref:System.IO.Stream> de compression autour du flux d'origine.</span><span class="sxs-lookup"><span data-stu-id="1287c-108">In this case the original transport <xref:System.IO.Stream> is replaced with one that wraps the compression <xref:System.IO.Stream> around the original one.</span></span>  
  
 <span data-ttu-id="1287c-109">Vous pouvez appliquer plusieurs mises à niveau de flux, chacune encapsulant la précédente.</span><span class="sxs-lookup"><span data-stu-id="1287c-109">You can apply multiple stream upgrades, each wrapping the preceding one.</span></span>  
  
## <a name="how-stream-upgrades-work"></a><span data-ttu-id="1287c-110">Fonctionnement des mises à niveau de flux</span><span class="sxs-lookup"><span data-stu-id="1287c-110">How Stream Upgrades Work</span></span>  
 <span data-ttu-id="1287c-111">Le processus de mise à niveau de flux comporte quatre composants.</span><span class="sxs-lookup"><span data-stu-id="1287c-111">There are four components to the stream upgrade process.</span></span>  
  
1.  <span data-ttu-id="1287c-112">Un flux de mise à niveau *initiateur* commence le processus : au moment de l’exécution, il peut initier une demande à l’autre extrémité de sa connexion pour mettre à niveau de la couche de transport de canal.</span><span class="sxs-lookup"><span data-stu-id="1287c-112">An upgrade stream *Initiator* begins the process: at run-time it can initiate a request to the other end of its connection to upgrade the channel transport layer.</span></span>  
  
2.  <span data-ttu-id="1287c-113">Un flux de mise à niveau *accepteur* effectue la mise à niveau : au moment de l’exécution qu’il reçoit la demande de mise à niveau à partir de l’autre ordinateur et si possible, accepte la mise à niveau.</span><span class="sxs-lookup"><span data-stu-id="1287c-113">An upgrade stream *Acceptor* carries out the upgrade: at run-time it receives the upgrade request from the other machine, and if possible, accepts the upgrade.</span></span>  
  
3.  <span data-ttu-id="1287c-114">Une mise à niveau *fournisseur* crée le *initiateur* sur le client et le *accepteur* sur le serveur.</span><span class="sxs-lookup"><span data-stu-id="1287c-114">An upgrade *Provider* creates the *Initiator* on the client and the *Acceptor* on the server.</span></span>  
  
4.  <span data-ttu-id="1287c-115">Une mise à niveau de flux *élément de liaison* est ajouté aux liaisons sur le service et le client et crée le fournisseur lors de l’exécution.</span><span class="sxs-lookup"><span data-stu-id="1287c-115">A stream upgrade *Binding Element* is added to the bindings on the service and the client, and creates the provider at runtime.</span></span>  
  
 <span data-ttu-id="1287c-116">Notez que dans le cas de plusieurs mises à niveau, l'initiateur et l'accepteur encapsulent des ordinateurs d'état pour appliquer les transitions de mise à niveau valides pour chaque initiation.</span><span class="sxs-lookup"><span data-stu-id="1287c-116">Note that in the case of multiple upgrades, the Initiator and Acceptor encapsulate state machines to enforce which upgrade transitions are valid for each Initiation.</span></span>  
  
## <a name="how-to-implement-a-stream-upgrade"></a><span data-ttu-id="1287c-117">Comment implémenter une mise à niveau de flux</span><span class="sxs-lookup"><span data-stu-id="1287c-117">How to Implement a Stream Upgrade</span></span>  
 [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)]<span data-ttu-id="1287c-118"> fournit quatre classes `abstract` que vous pouvez implémenter :</span><span class="sxs-lookup"><span data-stu-id="1287c-118"> provides four `abstract` classes that you can implement:</span></span>  
  
-   <xref:System.ServiceModel.Channels.StreamUpgradeInitiator?displayProperty=nameWithType>  
  
-   <xref:System.ServiceModel.Channels.StreamUpgradeAcceptor?displayProperty=nameWithType>  
  
-   <xref:System.ServiceModel.Channels.StreamUpgradeProvider?displayProperty=nameWithType>  
  
-   <xref:System.ServiceModel.Channels.StreamUpgradeBindingElement?displayProperty=nameWithType>  
  
 <span data-ttu-id="1287c-119">Pour implémenter une mise à niveau de flux personnalisée, procédez comme suit.</span><span class="sxs-lookup"><span data-stu-id="1287c-119">To implement a custom stream upgrade, do the following.</span></span> <span data-ttu-id="1287c-120">Cette procédure implémente un processus de mise à niveau de flux minimal sur les ordinateurs client et serveur.</span><span class="sxs-lookup"><span data-stu-id="1287c-120">This procedure implements a minimal stream upgrade process on both the client and server machines.</span></span>  
  
1.  <span data-ttu-id="1287c-121">Créez une classe qui implémente <xref:System.ServiceModel.Channels.StreamUpgradeInitiator>.</span><span class="sxs-lookup"><span data-stu-id="1287c-121">Create a class that implements <xref:System.ServiceModel.Channels.StreamUpgradeInitiator>.</span></span>  
  
    1.  <span data-ttu-id="1287c-122">Substituez la méthode <xref:System.ServiceModel.Channels.StreamUpgradeInitiator.InitiateUpgrade%2A> à appliquer au flux à mettre à niveau et retournez le flux mis à niveau.</span><span class="sxs-lookup"><span data-stu-id="1287c-122">Override the <xref:System.ServiceModel.Channels.StreamUpgradeInitiator.InitiateUpgrade%2A> method to take in the stream to be upgraded, and return the upgraded stream.</span></span> <span data-ttu-id="1287c-123">Cette méthode fonctionne de façon synchrone ; il existe des méthodes analogues pour initier la mise à niveau de façon asynchrone.</span><span class="sxs-lookup"><span data-stu-id="1287c-123">This method works synchronously; there are analogous methods to initiate the upgrade asynchronously.</span></span>  
  
    2.  <span data-ttu-id="1287c-124">Substituez la méthode <xref:System.ServiceModel.Channels.StreamUpgradeInitiator.GetNextUpgrade%2A> pour rechercher des mises à niveau supplémentaires.</span><span class="sxs-lookup"><span data-stu-id="1287c-124">Override the <xref:System.ServiceModel.Channels.StreamUpgradeInitiator.GetNextUpgrade%2A> method to check for additional upgrades.</span></span>  
  
2.  <span data-ttu-id="1287c-125">Créez une classe qui implémente <xref:System.ServiceModel.Channels.StreamUpgradeAcceptor>.</span><span class="sxs-lookup"><span data-stu-id="1287c-125">Create a class that implements <xref:System.ServiceModel.Channels.StreamUpgradeAcceptor>.</span></span>  
  
    1.  <span data-ttu-id="1287c-126">Substituez la méthode <xref:System.ServiceModel.Channels.StreamUpgradeAcceptor.AcceptUpgrade%2A> à appliquer au flux à mettre à niveau et retournez le flux mis à niveau.</span><span class="sxs-lookup"><span data-stu-id="1287c-126">Override the <xref:System.ServiceModel.Channels.StreamUpgradeAcceptor.AcceptUpgrade%2A> method to take in the stream to be upgraded, and return the upgraded stream.</span></span> <span data-ttu-id="1287c-127">Cette méthode fonctionne de façon synchrone ; il existe des méthodes analogues pour accepter la mise à niveau de façon asynchrone.</span><span class="sxs-lookup"><span data-stu-id="1287c-127">This method works synchronously; there are analogous methods to accept the upgrade asynchronously.</span></span>  
  
    2.  <span data-ttu-id="1287c-128">Substituez la méthode <xref:System.ServiceModel.Channels.StreamUpgradeAcceptor.CanUpgrade%2A> pour déterminer si la mise à niveau demandée est prise en charge, à ce stade, par cet accepteur de mise à niveau, lors du processus de mise à niveau.</span><span class="sxs-lookup"><span data-stu-id="1287c-128">Override the <xref:System.ServiceModel.Channels.StreamUpgradeAcceptor.CanUpgrade%2A> method to determine if the upgrade requested is supported by this upgrade acceptor at this point in the upgrade process.</span></span>  
  
3.  <span data-ttu-id="1287c-129">Créez une classe qui implémente <xref:System.ServiceModel.Channels.StreamUpgradeProvider>.</span><span class="sxs-lookup"><span data-stu-id="1287c-129">Create a class the implements <xref:System.ServiceModel.Channels.StreamUpgradeProvider>.</span></span> <span data-ttu-id="1287c-130">Substituez les méthodes <xref:System.ServiceModel.Channels.StreamUpgradeProvider.CreateUpgradeAcceptor%2A> et <xref:System.ServiceModel.Channels.StreamUpgradeProvider.CreateUpgradeInitiator%2A> pour retourner des instances de l'accepteur et de l'initiateur définies aux étapes 2 et 1.</span><span class="sxs-lookup"><span data-stu-id="1287c-130">Override the <xref:System.ServiceModel.Channels.StreamUpgradeProvider.CreateUpgradeAcceptor%2A> and the <xref:System.ServiceModel.Channels.StreamUpgradeProvider.CreateUpgradeInitiator%2A> methods to return instances of the acceptor and initiator defined in steps 2 and 1.</span></span>  
  
4.  <span data-ttu-id="1287c-131">Créez une classe qui implémente <xref:System.ServiceModel.Channels.StreamUpgradeBindingElement>.</span><span class="sxs-lookup"><span data-stu-id="1287c-131">Create a class that implements <xref:System.ServiceModel.Channels.StreamUpgradeBindingElement>.</span></span>  
  
    1.  <span data-ttu-id="1287c-132">Substituez la méthode <xref:System.ServiceModel.Channels.StreamUpgradeBindingElement.BuildClientStreamUpgradeProvider%2A> sur le client et la méthode <xref:System.ServiceModel.Channels.StreamUpgradeBindingElement.BuildServerStreamUpgradeProvider%2A> sur le service.</span><span class="sxs-lookup"><span data-stu-id="1287c-132">Override the <xref:System.ServiceModel.Channels.StreamUpgradeBindingElement.BuildClientStreamUpgradeProvider%2A> method on the client and the <xref:System.ServiceModel.Channels.StreamUpgradeBindingElement.BuildServerStreamUpgradeProvider%2A> method on the service.</span></span>  
  
    2.  <span data-ttu-id="1287c-133">Substituez la méthode <xref:System.ServiceModel.Channels.BindingElement.BuildChannelFactory%2A> sur le client et la méthode <xref:System.ServiceModel.Channels.BindingElement.BuildChannelListener%2A> sur le service pour ajouter l'élément de liaison de mise à niveau à <xref:System.ServiceModel.Channels.BindingContext.BindingParameters%2A>.</span><span class="sxs-lookup"><span data-stu-id="1287c-133">Override the <xref:System.ServiceModel.Channels.BindingElement.BuildChannelFactory%2A> method on the client and the <xref:System.ServiceModel.Channels.BindingElement.BuildChannelListener%2A> method on the service to add the upgrade Binding Element to <xref:System.ServiceModel.Channels.BindingContext.BindingParameters%2A>.</span></span>  
  
5.  <span data-ttu-id="1287c-134">Ajoutez le nouvel élément de liaison de mise à niveau de flux aux liaisons sur les ordinateurs serveur et client.</span><span class="sxs-lookup"><span data-stu-id="1287c-134">Add the new stream upgrade binding element to bindings on the server and client machines.</span></span>  
  
## <a name="security-upgrades"></a><span data-ttu-id="1287c-135">Mises à niveau de sécurité</span><span class="sxs-lookup"><span data-stu-id="1287c-135">Security Upgrades</span></span>  
 <span data-ttu-id="1287c-136">L'ajout d'une mise à niveau de sécurité est une version spécialisée du processus de mise à niveau de flux général.</span><span class="sxs-lookup"><span data-stu-id="1287c-136">Adding a security upgrade is a specialized version of the general stream upgrade process.</span></span>  
  
 [!INCLUDE[indigo2](../../../../includes/indigo2-md.md)]<span data-ttu-id="1287c-137"> fournit déjà deux éléments de liaison pour mettre à niveau la sécurité de flux.</span><span class="sxs-lookup"><span data-stu-id="1287c-137"> already provides two binding elements for upgrading stream security.</span></span> <span data-ttu-id="1287c-138">La configuration de sécurité au niveau du transport est encapsulée par <xref:System.ServiceModel.Channels.WindowsStreamSecurityBindingElement> et <xref:System.ServiceModel.Channels.SslStreamSecurityBindingElement> qui peuvent être configurés et ajoutés à une liaison personnalisée.</span><span class="sxs-lookup"><span data-stu-id="1287c-138">The configuration of transport-level security is encapsulated by the <xref:System.ServiceModel.Channels.WindowsStreamSecurityBindingElement> and the <xref:System.ServiceModel.Channels.SslStreamSecurityBindingElement> which can be configured and added to a custom binding.</span></span> <span data-ttu-id="1287c-139">Ces éléments de liaison étendent la classe <xref:System.ServiceModel.Channels.StreamUpgradeBindingElement> qui génère les fournisseurs de mise à niveau de flux client et serveur.</span><span class="sxs-lookup"><span data-stu-id="1287c-139">These binding elements extend the <xref:System.ServiceModel.Channels.StreamUpgradeBindingElement> class that builds the client and server stream upgrade providers.</span></span> <span data-ttu-id="1287c-140">Ces éléments de liaison ont des méthodes qui créent les classes de fournisseur de mise à niveau de flux de sécurité spécialisées, qui ne sont pas `public` ; par conséquent, dans ces deux cas, il vous suffit d'ajouter l'élément de liaison à la liaison.</span><span class="sxs-lookup"><span data-stu-id="1287c-140">These binding elements have methods that create the specialized security stream upgrade provider classes, which are not `public`, so for these two cases all you need to do is to add the binding element to the binding.</span></span>  
  
 <span data-ttu-id="1287c-141">Pour les scénarios de sécurité incompatibles avec les deux éléments de liaison précités, trois classes `abstract` relatives à la sécurité sont dérivées des classes de base d'initiateur, d'accepteur et de fournisseur précitées :</span><span class="sxs-lookup"><span data-stu-id="1287c-141">For security scenarios not met by the above two binding elements, three security-related `abstract` classes are derived from the above initiator, acceptor and provider base classes:</span></span>  
  
1.  <xref:System.ServiceModel.Channels.StreamSecurityUpgradeInitiator?displayProperty=nameWithType>  
  
2.  <xref:System.ServiceModel.Channels.StreamSecurityUpgradeAcceptor?displayProperty=nameWithType>  
  
3.  <xref:System.ServiceModel.Channels.StreamSecurityUpgradeProvider?displayProperty=nameWithType>  
  
 <span data-ttu-id="1287c-142">Le processus d'implémentation d'une mise à niveau de flux de sécurité est le même que précédemment, à ceci près que vous dérivez les données de ces trois classes.</span><span class="sxs-lookup"><span data-stu-id="1287c-142">The process of implementing a security stream upgrade is the same as before, with the difference that you would derive from these three classes.</span></span> <span data-ttu-id="1287c-143">Substituez les propriétés supplémentaires dans ces classes pour fournir des informations de sécurité au runtime.</span><span class="sxs-lookup"><span data-stu-id="1287c-143">Override the additional properties in these classes to supply security information to the runtime.</span></span>  
  
## <a name="multiple-upgrades"></a><span data-ttu-id="1287c-144">Mises à niveau multiples</span><span class="sxs-lookup"><span data-stu-id="1287c-144">Multiple Upgrades</span></span>  
 <span data-ttu-id="1287c-145">Pour créer des demandes de mise à niveau supplémentaires répétez le processus précité : créez des extensions supplémentaires du <xref:System.ServiceModel.Channels.StreamUpgradeProvider> et des éléments de liaison.</span><span class="sxs-lookup"><span data-stu-id="1287c-145">To create additional upgrade requests repeat the above process: create additional extensions of <xref:System.ServiceModel.Channels.StreamUpgradeProvider> and binding elements.</span></span> <span data-ttu-id="1287c-146">Ajoutez les éléments de liaison à la liaison.</span><span class="sxs-lookup"><span data-stu-id="1287c-146">Add the binding elements to the binding.</span></span> <span data-ttu-id="1287c-147">Les éléments de liaison supplémentaires sont traités de manière séquentielle, en commençant par le premier élément de liaison ajouté à la liaison.</span><span class="sxs-lookup"><span data-stu-id="1287c-147">The additional binding elements are processed sequentially, starting with the first binding element added to the binding.</span></span> <span data-ttu-id="1287c-148">Dans <xref:System.ServiceModel.Channels.BindingElement.BuildChannelFactory%2A> et <xref:System.ServiceModel.Channels.BindingElement.BuildChannelListener%2A> chaque fournisseur de mise à niveau peut déterminer comment venir s'ajouter à tout paramètre de liaison de mise à niveau préexistant.</span><span class="sxs-lookup"><span data-stu-id="1287c-148">In <xref:System.ServiceModel.Channels.BindingElement.BuildChannelFactory%2A> and <xref:System.ServiceModel.Channels.BindingElement.BuildChannelListener%2A> each upgrade provider can determine how to layer itself on any pre-existing upgrade binding parameters.</span></span> <span data-ttu-id="1287c-149">Il doit ensuite remplacer le paramètre de liaison de mise à niveau existant par un nouveau paramètre de liaison de mise à niveau composite.</span><span class="sxs-lookup"><span data-stu-id="1287c-149">It should then replace the existing upgrade binding parameter with a new composite upgrade binding parameter.</span></span>  
  
 <span data-ttu-id="1287c-150">Un fournisseur de mise à niveau peut également prendre en charge plusieurs mises à niveau.</span><span class="sxs-lookup"><span data-stu-id="1287c-150">Alternatively, one upgrade provider can support multiple upgrades.</span></span> <span data-ttu-id="1287c-151">Par exemple, vous pouvez souhaiter implémenter un fournisseur de mise à niveau de flux personnalisé qui prend en charge à la fois la sécurité et la compression.</span><span class="sxs-lookup"><span data-stu-id="1287c-151">For example, you might want to implement a custom stream upgrade provider that supports both security and compression.</span></span> <span data-ttu-id="1287c-152">Procédez comme suit :</span><span class="sxs-lookup"><span data-stu-id="1287c-152">Do the following steps:</span></span>  
  
1.  <span data-ttu-id="1287c-153">Sous-classez <xref:System.ServiceModel.Channels.StreamSecurityUpgradeProvider> pour écrire la classe de fournisseur qui crée l'initiateur et l'accepteur.</span><span class="sxs-lookup"><span data-stu-id="1287c-153">Subclass <xref:System.ServiceModel.Channels.StreamSecurityUpgradeProvider> to write the provider class that creates the Initiator and Acceptor.</span></span>  
  
2.  <span data-ttu-id="1287c-154">Sous-classez <xref:System.ServiceModel.Channels.StreamSecurityUpgradeInitiator> en veillant à substituer la méthode <xref:System.ServiceModel.Channels.StreamUpgradeInitiator.GetNextUpgrade%2A> pour retourner les types de contenu pour le flux de compression et le flux sécurisé dans l'ordre.</span><span class="sxs-lookup"><span data-stu-id="1287c-154">Subclass the <xref:System.ServiceModel.Channels.StreamSecurityUpgradeInitiator> making sure to override the <xref:System.ServiceModel.Channels.StreamUpgradeInitiator.GetNextUpgrade%2A> method to return the content types for the compression stream and the secure stream in order.</span></span>  
  
3.  <span data-ttu-id="1287c-155">Sous-classez <xref:System.ServiceModel.Channels.StreamSecurityUpgradeAcceptor> qui reconnaît les types de contenu personnalisés dans sa méthode <xref:System.ServiceModel.Channels.StreamUpgradeAcceptor.CanUpgrade%2A>.</span><span class="sxs-lookup"><span data-stu-id="1287c-155">Subclass the <xref:System.ServiceModel.Channels.StreamSecurityUpgradeAcceptor> that understands the custom content types in its <xref:System.ServiceModel.Channels.StreamUpgradeAcceptor.CanUpgrade%2A> method.</span></span>  
  
4.  <span data-ttu-id="1287c-156">Le flux sera mis à niveau après chaque appel à <xref:System.ServiceModel.Channels.StreamUpgradeInitiator.GetNextUpgrade%2A> et <xref:System.ServiceModel.Channels.StreamUpgradeAcceptor.CanUpgrade%2A>.</span><span class="sxs-lookup"><span data-stu-id="1287c-156">The stream will be upgraded after each call to <xref:System.ServiceModel.Channels.StreamUpgradeInitiator.GetNextUpgrade%2A> and <xref:System.ServiceModel.Channels.StreamUpgradeAcceptor.CanUpgrade%2A>.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="1287c-157">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="1287c-157">See Also</span></span>  
 <xref:System.ServiceModel.Channels.StreamUpgradeInitiator>  
 <xref:System.ServiceModel.Channels.StreamSecurityUpgradeInitiator>  
 <xref:System.ServiceModel.Channels.StreamUpgradeAcceptor>  
 <xref:System.ServiceModel.Channels.StreamSecurityUpgradeAcceptor>  
 <xref:System.ServiceModel.Channels.StreamUpgradeProvider>  
 <xref:System.ServiceModel.Channels.StreamSecurityUpgradeProvider>  
 <xref:System.ServiceModel.Channels.StreamUpgradeBindingElement>  
 <xref:System.ServiceModel.Channels.SslStreamSecurityBindingElement>  
 <xref:System.ServiceModel.Channels.WindowsStreamSecurityBindingElement>
