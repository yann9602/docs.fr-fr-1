---
title: Exemple Discovery Security
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net-framework
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-clr
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: b8db01f4-b4a1-43fe-8e31-26d4e9304a65
caps.latest.revision: "13"
author: BrucePerlerMS
ms.author: bruceper
manager: mbaldwin
ms.openlocfilehash: 2b21017be0927f0d5189744111437c5afa6dd623
ms.sourcegitcommit: bd1ef61f4bb794b25383d3d72e71041a5ced172e
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 10/18/2017
---
# <a name="discovery-security-sample"></a><span data-ttu-id="92a95-102">Exemple Discovery Security</span><span class="sxs-lookup"><span data-stu-id="92a95-102">Discovery Security Sample</span></span>
<span data-ttu-id="92a95-103">La spécification Discovery n'exige pas que les points de terminaison participant au processus de découverte soient sécurisés.</span><span class="sxs-lookup"><span data-stu-id="92a95-103">The Discovery specification does not require that endpoints that participate in the discovery process to be secure.</span></span> <span data-ttu-id="92a95-104">L'ajout de la sécurité aux messages de découverte atténue divers types d'attaques (altération de messages, déni de service, relecture, usurpation).</span><span class="sxs-lookup"><span data-stu-id="92a95-104">Enhancing the discovery messages with security mitigates various types of attacks (message alteration, denial of service, replay, spoofing).</span></span> <span data-ttu-id="92a95-105">Cet exemple implémente des canaux personnalisés qui calculent et vérifient des signatures de message utilisant le format de signature compact (décrit dans la section 8.2 de la spécification WS-Discovery).</span><span class="sxs-lookup"><span data-stu-id="92a95-105">This sample implements custom channels that compute and verify message signatures using the compact signature format (described in Section 8.2 of the WS-Discovery specification).</span></span> <span data-ttu-id="92a95-106">L’exemple prend en charge la [spécification Discovery 2005](http://go.microsoft.com/fwlink/?LinkId=177912) et [version 1.1](http://go.microsoft.com/fwlink/?LinkId=179677).</span><span class="sxs-lookup"><span data-stu-id="92a95-106">The sample supports both the [2005 Discovery specification](http://go.microsoft.com/fwlink/?LinkId=177912) and the [1.1 version](http://go.microsoft.com/fwlink/?LinkId=179677).</span></span>  
  
 <span data-ttu-id="92a95-107">Le canal personnalisé est appliqué en plus de la pile de canaux existante pour les points de terminaison de découverte et d'annonce.</span><span class="sxs-lookup"><span data-stu-id="92a95-107">The custom channel is applied on top of the existing channel stack for Discovery and Announcement endpoints.</span></span> <span data-ttu-id="92a95-108">De cette façon, un en-tête de signature est appliqué pour chaque message envoyé.</span><span class="sxs-lookup"><span data-stu-id="92a95-108">This way, a signature header is applied for every message sent.</span></span> <span data-ttu-id="92a95-109">La signature est vérifiée sur les messages reçus, qui sont supprimés s'ils ne comportent pas de signature ou si celle-ci ne correspond pas.</span><span class="sxs-lookup"><span data-stu-id="92a95-109">The signature is verified on received messages and when it does not match or when the messages do not have a signature, the messages are dropped.</span></span> <span data-ttu-id="92a95-110">Pour signer et vérifier des messages, l'exemple utilise des certificats.</span><span class="sxs-lookup"><span data-stu-id="92a95-110">To sign and verify messages, the sample uses certificates.</span></span>  
  
## <a name="discussion"></a><span data-ttu-id="92a95-111">Discussion</span><span class="sxs-lookup"><span data-stu-id="92a95-111">Discussion</span></span>  
 <span data-ttu-id="92a95-112">WCF est très extensible et offre aux utilisateurs la possibilité de personnaliser des canaux à leur gré.</span><span class="sxs-lookup"><span data-stu-id="92a95-112">WCF is very extensible and allows users the possibility to customize channels as desired.</span></span> <span data-ttu-id="92a95-113">L'exemple implémente un élément de liaison sécurisée de découverte qui génère des canaux sécurisés.</span><span class="sxs-lookup"><span data-stu-id="92a95-113">The sample implements a discovery secure binding element that builds secure channels.</span></span> <span data-ttu-id="92a95-114">Les canaux sécurisés appliquent et vérifient les signatures des messages et sont appliqués en plus de la pile actuelle.</span><span class="sxs-lookup"><span data-stu-id="92a95-114">The secure channels apply and verify message signatures and are applied on top of the current stack.</span></span>  
  
 <span data-ttu-id="92a95-115">L'élément de liaison sécurisée génère des écouteurs et fabriques de canaux sécurisés.</span><span class="sxs-lookup"><span data-stu-id="92a95-115">The secure binding element builds secure channel factories and channel listeners.</span></span>  
  
## <a name="secure-channel-factory"></a><span data-ttu-id="92a95-116">Fabrique de canaux sécurisés</span><span class="sxs-lookup"><span data-stu-id="92a95-116">Secure Channel Factory</span></span>  
 <span data-ttu-id="92a95-117">La fabrique de canaux sécurisés crée des canaux de sortie ou duplex qui ajoutent une signature compacte aux en-têtes de message.</span><span class="sxs-lookup"><span data-stu-id="92a95-117">The secure channel factory creates output or duplex channels that add a compact signature to message headers.</span></span> <span data-ttu-id="92a95-118">Pour garder les messages aussi petits que possible, le format de signature compact est utilisé.</span><span class="sxs-lookup"><span data-stu-id="92a95-118">To keep messages as small as possible the compact signature format is used.</span></span> <span data-ttu-id="92a95-119">La structure d'une signature compacte est représentée dans l'exemple suivant.</span><span class="sxs-lookup"><span data-stu-id="92a95-119">The structure of a compact signature is shown in the following example.</span></span>  
  
```xml  
<d:Security ... >   
  [<d:Sig Scheme="xs:anyURI"   
         [KeyId="xs:base64Binary"]?  
          Refs="..."  
         [PrefixList]="xs:NMTOKENS"   
          Sig="xs:base64Binary"   
          ... />]?  
  ...   
</d:Security>  
```  
  
> [!NOTE]
>  <span data-ttu-id="92a95-120">Le `PrefixList` a été ajouté dans le protocole Discovery version 2008.</span><span class="sxs-lookup"><span data-stu-id="92a95-120">The `PrefixList` was added in the 2008 Discovery version protocol.</span></span>  
  
 <span data-ttu-id="92a95-121">Pour calculer la signature, l'exemple identifie les éléments de signature développés.</span><span class="sxs-lookup"><span data-stu-id="92a95-121">To compute the signature, the sample determines the expanded signature items.</span></span> <span data-ttu-id="92a95-122">Une signature XML (`SignedInfo`) est créée, à l'aide du préfixe d'espace de noms `ds`, comme requis par la spécification WS-Discovery.</span><span class="sxs-lookup"><span data-stu-id="92a95-122">An XML signature (`SignedInfo`) is created, using the `ds` namespace prefix, as required by the WS-Discovery specification.</span></span> <span data-ttu-id="92a95-123">Le corps et tous les en-têtes des espaces de noms de découverte et d'adressage sont référencés dans la signature et ne peuvent donc pas être falsifiés.</span><span class="sxs-lookup"><span data-stu-id="92a95-123">The body and all the headers in discovery and addressing namespaces are referenced in the signature, so they cannot be tampered with.</span></span> <span data-ttu-id="92a95-124">Chaque élément référencé est transformé à l'aide de la canonicalisation exclusive (http://www.w3.org/2001/10/xml-exc-c14n#, page en anglais), puis une valeur Digest SHA-1 est calculée (http://www.w3.org/2000/09/xmldsig#sha1, page en anglais).</span><span class="sxs-lookup"><span data-stu-id="92a95-124">Each referenced element is transformed using the Exclusive Canonicalization (http://www.w3.org/2001/10/xml-exc-c14n# ), and then an SHA-1 digest value is computed (http://www.w3.org/2000/09/xmldsig#sha1 ).</span></span> <span data-ttu-id="92a95-125">D'après tous les éléments référencés et leur valeur Digest, la valeur de la signature est calculée à l'aide de l'algorithme RSA (http://www.w3.org/2000/09/xmldsig#rsa-sha1, page en anglais).</span><span class="sxs-lookup"><span data-stu-id="92a95-125">Based on all referenced elements and their digest values, the signature value is computed using the RSA algorithm (http://www.w3.org/2000/09/xmldsig#rsa-sha1 ).</span></span>  
  
 <span data-ttu-id="92a95-126">Les messages sont signés avec un certificat spécifié par le client.</span><span class="sxs-lookup"><span data-stu-id="92a95-126">The messages are signed with a client-specified certificate.</span></span> <span data-ttu-id="92a95-127">L'emplacement et le nom du magasin, ainsi que le nom de sujet du certificat doivent être spécifiés au moment de la création de l'élément de liaison.</span><span class="sxs-lookup"><span data-stu-id="92a95-127">The store location, name and the certificate subject name must be specified when the binding element is created.</span></span> <span data-ttu-id="92a95-128">Le `KeyId` de la signature compacte représente l'identificateur de clé du jeton de signature et constitue l'identificateur de la clé du sujet (SKI, Subject Key Identifier) du jeton de signature ou, si le SKI n'existe pas, un hachage SHA-1 de la clé publique du jeton de signature.</span><span class="sxs-lookup"><span data-stu-id="92a95-128">The `KeyId` in the compact signature represents the key identifier of the signing token and is the Subject Key Identifier (SKI) of the signing token or (if the SKI does not exist) a SHA-1 hash of the public key of the signing token.</span></span>  
  
## <a name="secure-channel-listener"></a><span data-ttu-id="92a95-129">Écouteur de canal sécurisé</span><span class="sxs-lookup"><span data-stu-id="92a95-129">Secure Channel Listener</span></span>  
 <span data-ttu-id="92a95-130">L'écouteur de canal sécurisé crée des canaux d'entrée ou duplex qui vérifient la signature compacte dans les messages reçus.</span><span class="sxs-lookup"><span data-stu-id="92a95-130">The secure channel listener creates input or duplex channels that verify the compact signature in received messages.</span></span> <span data-ttu-id="92a95-131">Pour vérifier la signature, le `KeyId` spécifié dans la signature compacte jointe au message est utilisé afin de sélectionner un certificat dans le magasin spécifié.</span><span class="sxs-lookup"><span data-stu-id="92a95-131">To verify the signature, the `KeyId` specified in the compact signature attached to the message is used to select a certificate from the specified store.</span></span> <span data-ttu-id="92a95-132">Si le message n'a pas de signature ou si la vérification de la signature échoue, les messages sont supprimés.</span><span class="sxs-lookup"><span data-stu-id="92a95-132">If the message does not have a signature or the signature check fails, the messages are dropped.</span></span> <span data-ttu-id="92a95-133">Pour utiliser la liaison sécurisée, l'exemple définit une fabrique qui crée les <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> et <xref:System.ServiceModel.Discovery.UdpAnnouncementEndpoint> personnalisés avec l'élément de liaison sécurisée de découverte ajouté.</span><span class="sxs-lookup"><span data-stu-id="92a95-133">To use the secure binding, the sample defines a factory that creates custom <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> and <xref:System.ServiceModel.Discovery.UdpAnnouncementEndpoint> with the added discovery secure binding element.</span></span> <span data-ttu-id="92a95-134">Ces points de terminaison sécurisés peuvent être utilisés dans des écouteurs d'annonces de découverte et des services détectables.</span><span class="sxs-lookup"><span data-stu-id="92a95-134">These secure endpoints can be used in discovery announcement listeners and discoverable services.</span></span>  
  
## <a name="sample-details"></a><span data-ttu-id="92a95-135">Détails de l'exemple</span><span class="sxs-lookup"><span data-stu-id="92a95-135">Sample Details</span></span>  
 <span data-ttu-id="92a95-136">L'exemple comporte une bibliothèque et 4 applications console :</span><span class="sxs-lookup"><span data-stu-id="92a95-136">The sample includes a library and 4 console applications:</span></span>  
  
-   <span data-ttu-id="92a95-137">**DiscoverySecurityChannels**: une bibliothèque qui expose la liaison sécurisée.</span><span class="sxs-lookup"><span data-stu-id="92a95-137">**DiscoverySecurityChannels**: A library that exposes the secure binding.</span></span> <span data-ttu-id="92a95-138">Cette bibliothèque calcule et vérifie la signature compacte des messages sortants/entrants.</span><span class="sxs-lookup"><span data-stu-id="92a95-138">The library computes and verifies the compact signature for outgoing/incoming messages.</span></span>  
  
-   <span data-ttu-id="92a95-139">**Service**: service qui expose le contrat ICalculatorService, auto-hébergé.</span><span class="sxs-lookup"><span data-stu-id="92a95-139">**Service**: A service exposing ICalculatorService contract, self hosted.</span></span> <span data-ttu-id="92a95-140">Ce service est marqué comme étant détectable.</span><span class="sxs-lookup"><span data-stu-id="92a95-140">The service is marked as Discoverable.</span></span> <span data-ttu-id="92a95-141">L'utilisateur spécifie les informations du certificat utilisé pour signer des messages en spécifiant l'emplacement et le nom du magasin, ainsi que le nom du sujet ou autre identificateur unique pour le certificat, et le magasin où se trouvent les certificats clients (certificats utilisés pour vérifier la signature des messages entrants).</span><span class="sxs-lookup"><span data-stu-id="92a95-141">The user specifies the details of the certificate used to sign messages by specifying the store location and name and the subject name or other unique identifier for the certificate, and the store where the client certificates are located (the certificates used to check signature for incoming messages).</span></span> <span data-ttu-id="92a95-142">Sur la base de ces informations, un UdpDiscoveryEndpoint avec sécurité accrue est généré et utilisé.</span><span class="sxs-lookup"><span data-stu-id="92a95-142">Based on these details, a UdpDiscoveryEndpoint with added security is built and used.</span></span>  
  
-   <span data-ttu-id="92a95-143">**Client**: cette classe tente de découvrir un ICalculatorService et appeler des méthodes sur le service.</span><span class="sxs-lookup"><span data-stu-id="92a95-143">**Client**: This class tries to discover an ICalculatorService and to call methods on the service.</span></span> <span data-ttu-id="92a95-144">Là encore, un <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> avec sécurité accrue est généré et utilisé pour signer et vérifier les messages.</span><span class="sxs-lookup"><span data-stu-id="92a95-144">Again, a <xref:System.ServiceModel.Discovery.UdpDiscoveryEndpoint> with added security is built and used to sign and verify the messages.</span></span>  
  
-   <span data-ttu-id="92a95-145">**AnnouncementListener**: un service auto-hébergé qui écoute les annonces en ligne et hors connexion et utilise le point de terminaison d’annonce sécurisé.</span><span class="sxs-lookup"><span data-stu-id="92a95-145">**AnnouncementListener**: A self-hosted service that listens for online and offline announcements and uses the secure announcement endpoint.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="92a95-146">Si Setup.bat est exécuté plusieurs fois, des certificats sont dupliqués et le gestionnaire de certificats vous invite à choisir le certificat à ajouter.</span><span class="sxs-lookup"><span data-stu-id="92a95-146">If Setup.bat is run multiple times, the certificate manager prompts you for choosing a certificate to add, as there are duplicate certificates.</span></span> <span data-ttu-id="92a95-147">Dans ce cas, Setup.bat doit être abandonné et Cleanup.bat doit être appelé, car les doublons ont déjà été créés.</span><span class="sxs-lookup"><span data-stu-id="92a95-147">In that case, Setup.bat should be aborted and Cleanup.bat should be called, because the duplicates have already been created.</span></span> <span data-ttu-id="92a95-148">Cleanup.bat vous invite également à choisir le certificat à supprimer.</span><span class="sxs-lookup"><span data-stu-id="92a95-148">Cleanup.bat also prompts you to choose a certificate to delete.</span></span> <span data-ttu-id="92a95-149">Sélectionnez un certificat dans la liste et continuez à exécuter Cleanup.bat jusqu'à ce qu'il ne reste aucun certificat.</span><span class="sxs-lookup"><span data-stu-id="92a95-149">Select a certificate from the list and continue executing Cleanup.bat until no certificates are remaining.</span></span>  
  
#### <a name="to-use-this-sample"></a><span data-ttu-id="92a95-150">Pour utiliser cet exemple</span><span class="sxs-lookup"><span data-stu-id="92a95-150">To use this sample</span></span>  
  
1.  <span data-ttu-id="92a95-151">Exécutez le script Setup.bat à partir d'une invite de commandes de Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="92a95-151">Execute the Setup.bat script from a Visual Studio command prompt.</span></span> <span data-ttu-id="92a95-152">L'exemple utilise des certificats pour signer et vérifier des messages.</span><span class="sxs-lookup"><span data-stu-id="92a95-152">The sample uses certificates to sign and verify messages.</span></span> <span data-ttu-id="92a95-153">Le script crée les certificats à l'aide de Makecert.exe, puis les installe à l'aide de Certmgr.exe.</span><span class="sxs-lookup"><span data-stu-id="92a95-153">The script creates the certificates using Makecert.exe and then installs them using Certmgr.exe.</span></span> <span data-ttu-id="92a95-154">Le script doit être exécuté avec des privilèges d'administrateur.</span><span class="sxs-lookup"><span data-stu-id="92a95-154">The script must be run with administrator privileges.</span></span>  
  
2.  <span data-ttu-id="92a95-155">Pour générer et exécuter l’exemple, ouvrez le fichier Security.sln dans Visual Studio et choisissez **tout reconstruire**.</span><span class="sxs-lookup"><span data-stu-id="92a95-155">To build and run the sample, open the Security.sln file in Visual Studio and choose **Rebuild All**.</span></span> <span data-ttu-id="92a95-156">Mettre à jour les propriétés de la solution pour démarrer plusieurs projets : sélectionnez **Démarrer** pour tous les projets, à l’exception de DiscoverySecureChannels.</span><span class="sxs-lookup"><span data-stu-id="92a95-156">Update the solution properties to start multiple projects: select **Start** for all projects except DiscoverySecureChannels.</span></span> <span data-ttu-id="92a95-157">Exécutez la solution normalement.</span><span class="sxs-lookup"><span data-stu-id="92a95-157">Run the solution normally.</span></span>  
  
3.  <span data-ttu-id="92a95-158">Lorsque vous en avez terminé avec l'exemple, exécutez le script Cleanup.bat, qui supprime les certificats créés pour cet exemple.</span><span class="sxs-lookup"><span data-stu-id="92a95-158">After you are done with the sample, execute the Cleanup.bat script that removes the certificates created for this sample.</span></span>  
  
> [!IMPORTANT]
>  <span data-ttu-id="92a95-159">Les exemples peuvent déjà être installés sur votre ordinateur.</span><span class="sxs-lookup"><span data-stu-id="92a95-159">The samples may already be installed on your machine.</span></span> <span data-ttu-id="92a95-160">Recherchez le répertoire (par défaut) suivant avant de continuer.</span><span class="sxs-lookup"><span data-stu-id="92a95-160">Check for the following (default) directory before continuing.</span></span>  
>   
>  `<InstallDrive>:\WF_WCF_Samples`  
>   
>  <span data-ttu-id="92a95-161">Si ce répertoire n’existe pas, accédez à la page [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](http://go.microsoft.com/fwlink/?LinkId=150780) pour télécharger tous les exemples [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] et [!INCLUDE[wf1](../../../../includes/wf1-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="92a95-161">If this directory does not exist, go to [Windows Communication Foundation (WCF) and Windows Workflow Foundation (WF) Samples for .NET Framework 4](http://go.microsoft.com/fwlink/?LinkId=150780) to download all [!INCLUDE[indigo1](../../../../includes/indigo1-md.md)] and [!INCLUDE[wf1](../../../../includes/wf1-md.md)] samples.</span></span> <span data-ttu-id="92a95-162">Cet exemple se trouve dans le répertoire suivant.</span><span class="sxs-lookup"><span data-stu-id="92a95-162">This sample is located in the following directory.</span></span>  
>   
>  `<InstallDrive>:\WF_WCF_Samples\WCF\Scenario\DiscoveryScenario`  
  
## <a name="see-also"></a><span data-ttu-id="92a95-163">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="92a95-163">See Also</span></span>
