---
title: "Migration d’applications .NET Framework monolithiques héritées vers des conteneurs Windows"
description: "Architecture des microservices .NET pour les applications .NET en conteneur | Migration d’applications .NET Framework monolithiques héritées vers des conteneurs Windows"
keywords: Docker, microservices, ASP.NET, conteneur
author: CESARDELATORRE
ms.author: wiwagn
ms.date: 05/26/2017
ms.prod: .net-core
ms.technology: dotnet-docker
ms.topic: article
ms.workload:
- dotnet
- dotnetcore
ms.openlocfilehash: c88027156b55829f77357c1fdb1aef01a802b88a
ms.sourcegitcommit: e7f04439d78909229506b56935a1105a4149ff3d
ms.translationtype: HT
ms.contentlocale: fr-FR
ms.lasthandoff: 12/23/2017
---
# <a name="migrating-legacy-monolithic-net-framework-applications-to-windows-containers"></a><span data-ttu-id="55c19-104">Migration d’applications .NET Framework monolithiques héritées vers des conteneurs Windows</span><span class="sxs-lookup"><span data-stu-id="55c19-104">Migrating Legacy Monolithic .NET Framework Applications to Windows Containers</span></span>

<span data-ttu-id="55c19-105">*Vous pouvez utiliser les conteneurs Windows pour améliorer les environnements de développement et de test, ainsi que pour déployer des applications qui reposent sur des technologies .NET Framework héritées comme Web* *Forms. L’utilisation de conteneurs pour des applications héritées est appelée scénario « lift-and-shift ».*</span><span class="sxs-lookup"><span data-stu-id="55c19-105">*Windows Containers can be used as a way to improve development and test environments, and to deploy applications that are based on legacy .NET Framework technologies like Web* *Forms. Using containers for legacy applications in this way is referred to as a “lift and shift” scenario.*</span></span>

<span data-ttu-id="55c19-106">Les sections précédentes de ce guide ont défendu une architecture de microservices où les applications métier sont distribuées entre différents conteneurs, chacun exécutant un petit service ciblé.</span><span class="sxs-lookup"><span data-stu-id="55c19-106">Earlier sections of this guide have championed a microservices architecture where business applications are distributed among different containers, each running a small, focused service.</span></span> <span data-ttu-id="55c19-107">Cet objectif présente de nombreux avantages.</span><span class="sxs-lookup"><span data-stu-id="55c19-107">That goal has many benefits.</span></span> <span data-ttu-id="55c19-108">Dans tout nouveau développement, cette approche est fortement recommandée.</span><span class="sxs-lookup"><span data-stu-id="55c19-108">In new development, that approach is strongly recommended.</span></span> <span data-ttu-id="55c19-109">Les applications d’entreprise critiques en tirent également suffisamment parti pour justifier le coût d’une nouvelle architecture et d’une nouvelle implémentation.</span><span class="sxs-lookup"><span data-stu-id="55c19-109">Enterprise-critical applications will also benefit enough to justify the cost of a rearchitecture and reimplementation.</span></span>

<span data-ttu-id="55c19-110">Mais cela n’est pas vrai pour toutes les applications.</span><span class="sxs-lookup"><span data-stu-id="55c19-110">But not every application will benefit enough to justify the cost.</span></span> <span data-ttu-id="55c19-111">Cela ne signifie pas que ces applications ne peuvent pas être utilisées dans des scénarios de conteneur.</span><span class="sxs-lookup"><span data-stu-id="55c19-111">That does not mean that those applications cannot be used in container scenarios.</span></span>

<span data-ttu-id="55c19-112">Dans cette section, nous allons examiner une application pour eShopOnContainers, illustrée par la figure 7-1.</span><span class="sxs-lookup"><span data-stu-id="55c19-112">In this section, we will explore an application for eShopOnContainers, shown in Figure 7-1.</span></span> <span data-ttu-id="55c19-113">Cette application est utilisée par les membres de l’équipe de l’entreprise eShopOnContainers pour afficher et modifier le catalogue de produits.</span><span class="sxs-lookup"><span data-stu-id="55c19-113">This application would be used by members of the eShopOnContainers enterprise team to view and edit the product catalog.</span></span>

![](./media/image1.png)

<span data-ttu-id="55c19-114">**Figure 7-1**.</span><span class="sxs-lookup"><span data-stu-id="55c19-114">**Figure 7-1**.</span></span> <span data-ttu-id="55c19-115">Application ASP.NET Web Forms (technologie héritée) sur un conteneur Windows</span><span class="sxs-lookup"><span data-stu-id="55c19-115">ASP.NET Web Forms application (legacy technology) on a Windows Container</span></span>

<span data-ttu-id="55c19-116">Il s’agit d’une application Web Forms qui permet de parcourir et modifier les entrées du catalogue.</span><span class="sxs-lookup"><span data-stu-id="55c19-116">This is a Web Forms application that is used to browse and modify the catalog entries.</span></span> <span data-ttu-id="55c19-117">La dépendance Web Forms signifie que cette application ne s’exécute pas sur .NET Core sauf si elle est réécrite sans Web Forms et qu’elle utilise plutôt ASP.NET Core MVC.</span><span class="sxs-lookup"><span data-stu-id="55c19-117">The Web Forms dependency means this application will not run on .NET Core unless it is rewritten without Web Forms and instead uses ASP.NET Core MVC.</span></span> <span data-ttu-id="55c19-118">Vous allez voir comment il est possible d’exécuter des applications de ce type dans des conteneurs sans apporter de modifications.</span><span class="sxs-lookup"><span data-stu-id="55c19-118">You will see how you can run applications like these in containers without changes.</span></span> <span data-ttu-id="55c19-119">Vous allez également voir comment apporter des modifications minimales pour fonctionner en mode hybride où certaines fonctionnalités ont été déplacées dans un microservice distinct, alors que la plupart des autres fonctionnalités restent dans l’application monolithique.</span><span class="sxs-lookup"><span data-stu-id="55c19-119">You will also see how you can make minimal changes to work in a hybrid mode where some functionality has been moved into a separate microservice, but most functionality remains in the monolithic application.</span></span>

## <a name="benefits-of-containerizing-a-monolithic-application"></a><span data-ttu-id="55c19-120">Avantages de la mise en conteneur d’une application monolithique</span><span class="sxs-lookup"><span data-stu-id="55c19-120">Benefits of containerizing a monolithic application</span></span>

<span data-ttu-id="55c19-121">L’application Catalog.WebForms est disponible dans le dépôt GitHub eShopOnContainers (<https://github.com/dotnet/eShopOnContainers>).</span><span class="sxs-lookup"><span data-stu-id="55c19-121">The Catalog.WebForms application is available in the eShopOnContainers GitHub repository (<https://github.com/dotnet/eShopOnContainers>).</span></span> <span data-ttu-id="55c19-122">Cette application est une application web autonome qui accède à un magasin de données à haute disponibilité.</span><span class="sxs-lookup"><span data-stu-id="55c19-122">This application is a standalone web application accessing a high-availability data store.</span></span> <span data-ttu-id="55c19-123">Même dans ce cas, il existe des avantages à l’exécution de l’application dans un conteneur.</span><span class="sxs-lookup"><span data-stu-id="55c19-123">Even so, there are advantages to running the application in a container.</span></span> <span data-ttu-id="55c19-124">Vous créez une image de l’application.</span><span class="sxs-lookup"><span data-stu-id="55c19-124">You create an image for the application.</span></span> <span data-ttu-id="55c19-125">À partir de là, chaque déploiement s’exécute dans le même environnement.</span><span class="sxs-lookup"><span data-stu-id="55c19-125">From that point forward, every deployment runs in the same environment.</span></span> <span data-ttu-id="55c19-126">Chaque conteneur utilise la même version du système d’exploitation, a la même version des dépendances installées, utilise le même framework et est généré en utilisant le même processus.</span><span class="sxs-lookup"><span data-stu-id="55c19-126">Every container uses the same OS version, has the same version of dependencies installed, uses the same framework, and is built using the same process.</span></span> <span data-ttu-id="55c19-127">Vous pouvez voir l’application chargée dans Visual Studio 2017 dans la figure 7-2.</span><span class="sxs-lookup"><span data-stu-id="55c19-127">You can see the application loaded in Visual Studio 2017 in Figure 7-2.</span></span>

![](./media/image2.png)

<span data-ttu-id="55c19-128">**Figure 7-2**.</span><span class="sxs-lookup"><span data-stu-id="55c19-128">**Figure 7-2**.</span></span> <span data-ttu-id="55c19-129">Application Web Forms de gestion de catalogue dans Visual Studio 2017</span><span class="sxs-lookup"><span data-stu-id="55c19-129">Catalog management Web Forms application in Visual Studio 2017</span></span>

<span data-ttu-id="55c19-130">De plus, les développeurs peuvent tous exécuter l’application dans cet environnement cohérent.</span><span class="sxs-lookup"><span data-stu-id="55c19-130">In addition, developers can all run the application in this consistent environment.</span></span> <span data-ttu-id="55c19-131">Les problèmes qui n’apparaissent que dans certaines versions sont immédiatement visibles pour les développeurs, au lieu de faire surface dans un environnement de préproduction ou de production.</span><span class="sxs-lookup"><span data-stu-id="55c19-131">Issues that only appear with certain versions will appear immediately for developers rather than surfacing in a staging or production environment.</span></span> <span data-ttu-id="55c19-132">Les différences entre les environnements de développement parmi l’équipe de développement ont moins d’importance une fois que les applications s’exécutent dans des conteneurs.</span><span class="sxs-lookup"><span data-stu-id="55c19-132">Differences between the development environments among the development team matter less once applications run in containers.</span></span>

<span data-ttu-id="55c19-133">Enfin, les applications en conteneur ont une courbe de montée en puissance parallèle (scale out) plus plate.</span><span class="sxs-lookup"><span data-stu-id="55c19-133">Finally, containerized applications have a flatter scale-out curve.</span></span> <span data-ttu-id="55c19-134">Vous avez découvert comment les applications en conteneur activent d’autres conteneurs dans une machine virtuelle ou d’autres conteneurs dans une machine physique.</span><span class="sxs-lookup"><span data-stu-id="55c19-134">You have learned how containerized apps enable more containers in a VM or more containers in a physical machine.</span></span> <span data-ttu-id="55c19-135">Cela se traduit par une densité plus élevée et moins de ressources nécessaires.</span><span class="sxs-lookup"><span data-stu-id="55c19-135">This translates to higher density and fewer required resources.</span></span>

<span data-ttu-id="55c19-136">Pour toutes ces raisons, envisagez d’exécuter des applications monolithiques héritées dans un conteneur Docker à l’aide d’une opération « lift-and-shift ».</span><span class="sxs-lookup"><span data-stu-id="55c19-136">For all these reasons, consider running legacy monolithic apps in a Docker container using a “lift-and-shift” operation.</span></span> <span data-ttu-id="55c19-137">L’expression « lift-and-shift » décrit l’étendue de la tâche : vous *levez* l’ensemble de l’application à partir d’une machine physique ou virtuelle, puis vous la *déplacez* dans un conteneur.</span><span class="sxs-lookup"><span data-stu-id="55c19-137">The phrase “lift and shift” describes the scope of the task: you *lift* the entire application from a physical or virtual machine, and *shift* it into a container.</span></span> <span data-ttu-id="55c19-138">Dans les situations idéales, vous n’avez pas besoin d’apporter des modifications au code d’application pour l’exécuter dans un conteneur.</span><span class="sxs-lookup"><span data-stu-id="55c19-138">In ideal situations, you do not need to make any changes to the application code to run it in a container.</span></span>

## <a name="possible-migration-paths"></a><span data-ttu-id="55c19-139">Chemins de migration possibles</span><span class="sxs-lookup"><span data-stu-id="55c19-139">Possible migration paths</span></span>

<span data-ttu-id="55c19-140">Comme une application monolithique, l’application Catalog.Webforms est une application web contenant tout le code, y compris les bibliothèques d’accès aux données.</span><span class="sxs-lookup"><span data-stu-id="55c19-140">As a monolithic application, the Catalog.Webforms application is one web application containing all the code, including the data access libraries.</span></span> <span data-ttu-id="55c19-141">La base de données s’exécute sur une machine distincte à haute disponibilité.</span><span class="sxs-lookup"><span data-stu-id="55c19-141">The database runs on a separate high-availability machine.</span></span> <span data-ttu-id="55c19-142">Cette configuration est simulée dans l’exemple de code à l’aide d’un service de catalogue fictif : vous pouvez exécuter l’application Catalog.WebForms sur ces données fictives pour simuler un scénario « lift-and-shift » pur.</span><span class="sxs-lookup"><span data-stu-id="55c19-142">That configuration is simulated in the sample code by using a mock catalog service: you can run the Catalog.WebForms application against that fake data to simulate a pure lift-and-shift scenario.</span></span> <span data-ttu-id="55c19-143">Celui-ci montre le chemin de migration le plus simple, où vous déplacez des ressources existantes pour les exécuter dans un conteneur sans apporter du tout de modifications au code.</span><span class="sxs-lookup"><span data-stu-id="55c19-143">This demonstrates the simplest migration path, where you move existing assets to run in a container without any code changes at all.</span></span> <span data-ttu-id="55c19-144">Ce chemin convient aux applications qui sont terminées et qui ont une interaction minimale avec les fonctionnalités que vous déplacez vers des microservices.</span><span class="sxs-lookup"><span data-stu-id="55c19-144">This path is appropriate for applications that are complete and that have minimal interaction with functionality that you are moving to microservices.</span></span>

<span data-ttu-id="55c19-145">Toutefois, le site web eShopOnContainers accède déjà au stockage des données à l’aide de microservices pour différents scénarios.</span><span class="sxs-lookup"><span data-stu-id="55c19-145">However, the eShopOnContainers website is already accessing the data storage using microservices for different scenarios.</span></span> <span data-ttu-id="55c19-146">Certaines petites modifications supplémentaires peuvent être apportées à l’éditeur de catalogue pour exploiter le microservice du catalogue au lieu d’accéder au stockage de données de catalogue directement.</span><span class="sxs-lookup"><span data-stu-id="55c19-146">Some small additional changes can be made to the catalog editor to leverage the catalog microservice instead of accessing the catalog data storage directly.</span></span>

<span data-ttu-id="55c19-147">Ces modifications montrent le continuum de vos propres applications.</span><span class="sxs-lookup"><span data-stu-id="55c19-147">These changes demonstrate the continuum for your own applications.</span></span> <span data-ttu-id="55c19-148">Vous pouvez tout faire depuis le déplacement d’une application existante sans modification vers des conteneurs, jusqu’à l’apport de petites modifications qui permettent aux applications existantes d’accéder à certains des microservices en passant par la réécriture complète d’une application pour participer entièrement à une nouvelle architecture de microservice.</span><span class="sxs-lookup"><span data-stu-id="55c19-148">You can do anything from moving an existing application without change into containers, to making small changes that enable existing applications to access some of the new microservices, to completely rewriting an application to fully participate in a new microservice-based architecture.</span></span> <span data-ttu-id="55c19-149">Le bon chemin dépend à la fois du coût de la migration et des avantages liés à toute migration.</span><span class="sxs-lookup"><span data-stu-id="55c19-149">The right path depends on both the cost of the migration and the benefits from any migration.</span></span>

## <a name="application-tour"></a><span data-ttu-id="55c19-150">Présentation de l’application</span><span class="sxs-lookup"><span data-stu-id="55c19-150">Application tour</span></span>

<span data-ttu-id="55c19-151">Vous pouvez charger la solution Catalog.WebForms et exécuter l’application en tant qu’application autonome.</span><span class="sxs-lookup"><span data-stu-id="55c19-151">You can load the Catalog.WebForms solution and run the application as a standalone application.</span></span> <span data-ttu-id="55c19-152">Dans cette configuration, au lieu d’une base de données de stockage permanente, l’application utilise un faux service pour retourner des données.</span><span class="sxs-lookup"><span data-stu-id="55c19-152">In this configuration, instead of a persistent storage database, the application uses a fake service to return data.</span></span> <span data-ttu-id="55c19-153">L’application utilise Autofac (<https://autofac.org/>) en tant que conteneur d’inversion de contrôle.</span><span class="sxs-lookup"><span data-stu-id="55c19-153">The application uses Autofac (<https://autofac.org/>) as an inversion of control (IOC) container.</span></span> <span data-ttu-id="55c19-154">À l’aide de l’injection de dépendance, vous pouvez configurer l’application pour utiliser les fausses données ou le service de données de catalogue en direct.</span><span class="sxs-lookup"><span data-stu-id="55c19-154">Using Dependency Injection (DI), you can configure the application to use the fake data or the live catalog data service.</span></span> <span data-ttu-id="55c19-155">(Nous allons expliquer plus précisément l’injection de dépendance sous peu.) Le code de démarrage lit un paramètre useFake dans les fichiers web.config et configure le conteneur Autofac pour injecter soit le faux service de données ou le service de catalogue en direct.</span><span class="sxs-lookup"><span data-stu-id="55c19-155">(We will explain more about DI shortly.) The startup code reads a useFake setting from the web.config files, and configures the Autofac container to inject either the fake data service or the live catalog service.</span></span> <span data-ttu-id="55c19-156">Si vous exécutez l’application avec la valeur false pour useFake dans le fichier web.config, vous voyez l’application Web Forms afficher les données de catalogue.</span><span class="sxs-lookup"><span data-stu-id="55c19-156">If you run the application with useFake set to false in the web.config file, you see the Web Forms application displaying the catalog data.</span></span>

<span data-ttu-id="55c19-157">La plupart des techniques utilisées dans cette application sont certainement bien connues des personnes qui ont déjà utilisé Web Forms.</span><span class="sxs-lookup"><span data-stu-id="55c19-157">Most of the techniques used in this application should be very familiar to anyone who has used Web Forms.</span></span> <span data-ttu-id="55c19-158">Toutefois, le microservice du catalogue introduit deux techniques éventuellement nouvelles : l’injection de dépendance, qui a été mentionnée précédemment et l’utilisation de magasins de données asynchrones dans Web Forms.</span><span class="sxs-lookup"><span data-stu-id="55c19-158">However, the catalog microservice introduces two techniques that might be unfamiliar: Dependency Injection (DI), which was mentioned earlier, and working with asynchronous data stores in Web Forms.</span></span>

<span data-ttu-id="55c19-159">L’injection de dépendance inverse la stratégie orientée objet typique d’écriture de classes qui allouent toutes les ressources nécessaires.</span><span class="sxs-lookup"><span data-stu-id="55c19-159">DI inverts the typical object-oriented strategy of writing classes that allocate all needed resources.</span></span> <span data-ttu-id="55c19-160">Au lieu de cela, les classes demandent leurs dépendances à un conteneur de service.</span><span class="sxs-lookup"><span data-stu-id="55c19-160">Instead, classes request their dependencies from a service container.</span></span> <span data-ttu-id="55c19-161">L’avantage de l’injection de dépendance est que vous pouvez remplacer des services externes par des faux services (fictifs) pour prendre en charge des environnements de test ou autres.</span><span class="sxs-lookup"><span data-stu-id="55c19-161">The advantage of DI is that you can replace external services with fakes (mocks) to support testing or other environments.</span></span>

<span data-ttu-id="55c19-162">Le conteneur d’injection de dépendance utilise la configuration appSettings de web.config pour contrôler l’utilisation ou non des fausses données de catalogue ou les données en direct du service en cours d’exécution.</span><span class="sxs-lookup"><span data-stu-id="55c19-162">The DI container uses the web.config appSettings configuration to control whether to use the fake catalog data or the live data from the running service.</span></span> <span data-ttu-id="55c19-163">L’application enregistre un objet HttpModule qui crée le conteneur et inscrit un gestionnaire de demande préliminaire pour injecter des dépendances.</span><span class="sxs-lookup"><span data-stu-id="55c19-163">The application registers an HttpModule object that builds the container and registers a pre-request handler to inject dependencies.</span></span> <span data-ttu-id="55c19-164">Vous pouvez voir que le code dans le fichier Modules/AutoFacHttpModule.cs, qui ressemble à l’exemple suivant :</span><span class="sxs-lookup"><span data-stu-id="55c19-164">You can see that code in the Modules/AutoFacHttpModule.cs file, which looks like the following example:</span></span>

```cs
private static IContainer CreateContainer()
{
  // Configure AutoFac:
  // Register Containers:

  var settings = WebConfigurationManager.AppSettings;
  var useFake = settings["usefake"];
  bool fake = useFake == "true";
  var builder = new ContainerBuilder();

  if (fake)
  {
    builder.RegisterType<CatalogMockService>()
    .As<ICatalogService>();
  }
  else
  {
    builder.RegisterType<CatalogService>()
    .As<ICatalogService>();
    builder.RegisterType<RequestProvider>()
    .As<IRequestProvider>();
  }

  var container = builder.Build();
  return container;
}

private void InjectDependencies()
{
  if (HttpContext.Current.CurrentHandler is Page page)
  {
    // Get the code-behind class that we may have written
    var pageType = page.GetType().BaseType;

    // Determine if there is a constructor to inject, and grab it
    var ctor = (from c in pageType.GetConstructors()
                where c.GetParameters().Length > 0
                select c).FirstOrDefault();

    if (ctor != null)
    {
      // Resolve the parameters for the constructor
      var args = (from parm in ctor.GetParameters()
                  select Container.Resolve(parm.ParameterType))
                  .ToArray();

      // Execute the constructor method with the arguments resolved
      ctor.Invoke(page, args);
    }

    // Use the Autofac method to inject any
    // properties that can be filled by Autofac
    Container.InjectProperties(page);
  }
}
```

<span data-ttu-id="55c19-165">Les pages de l’application (Default.aspx.cs et EditPage.aspx.cs) définissent des constructeurs qui acceptent ces dépendances.</span><span class="sxs-lookup"><span data-stu-id="55c19-165">The application’s pages (Default.aspx.cs and EditPage.aspx.cs) define constructors that take these dependencies.</span></span> <span data-ttu-id="55c19-166">Notez que le constructeur par défaut est toujours présent et accessible.</span><span class="sxs-lookup"><span data-stu-id="55c19-166">Note that the default constructor is still present and accessible.</span></span> <span data-ttu-id="55c19-167">L’infrastructure a besoin du code suivant.</span><span class="sxs-lookup"><span data-stu-id="55c19-167">The infrastructure needs the following code.</span></span>

```cs
protected _Default() { }

public _Default(ICatalogService catalog) => this.catalog = catalog;
```

<span data-ttu-id="55c19-168">Les API de catalogue sont toutes des méthodes asynchrones.</span><span class="sxs-lookup"><span data-stu-id="55c19-168">The catalog APIs are all asynchronous methods.</span></span> <span data-ttu-id="55c19-169">Web Forms les prend désormais en charge pour tous les contrôles de données.</span><span class="sxs-lookup"><span data-stu-id="55c19-169">Web Forms now supports these for all data controls.</span></span> <span data-ttu-id="55c19-170">L’application Catalog.WebForms utilise la liaison de modèle pour les pages de liste et de modification ; les contrôles inclus dans les pages définissent les propriétés SelectMethod, UpdateMethod, InsertMethod et DeleteMethod qui spécifient des opérations asynchrones retournant des tâches.</span><span class="sxs-lookup"><span data-stu-id="55c19-170">The Catalog.WebForms application uses model binding for the list and edit pages; controls on the pages define SelectMethod, UpdateMethod, InsertMethod, and DeleteMethod properties that specify Task-returning asynchronous operations.</span></span> <span data-ttu-id="55c19-171">Les contrôles Web Forms comprennent à quel moment les méthodes liées à un contrôle sont asynchrones.</span><span class="sxs-lookup"><span data-stu-id="55c19-171">Web Forms controls understand when the methods bound to a control are asynchronous.</span></span> <span data-ttu-id="55c19-172">La seule restriction que vous rencontrez lors de l’utilisation de méthodes select asynchrones est que la pagination n’est pas prise en charge.</span><span class="sxs-lookup"><span data-stu-id="55c19-172">The only restriction you encounter when using asynchronous select methods is that you cannot support paging.</span></span> <span data-ttu-id="55c19-173">La signature de la pagination nécessite un paramètre de sortie alors que les méthodes asynchrones ne peuvent pas avoir de paramètres de sortie.</span><span class="sxs-lookup"><span data-stu-id="55c19-173">The paging signature requires an out parameter, and asynchronous methods cannot have out parameters.</span></span> <span data-ttu-id="55c19-174">Cette même technique est utilisée dans d’autres pages qui exigent des données du service de catalogue.</span><span class="sxs-lookup"><span data-stu-id="55c19-174">This same technique is used on other pages that require data from the catalog service.</span></span>

<span data-ttu-id="55c19-175">La configuration par défaut de l’application Web Forms de catalogue utilise une implémentation fictive du service catalog.api.</span><span class="sxs-lookup"><span data-stu-id="55c19-175">The default configuration for the catalog Web Forms application uses a mock implementation of the catalog.api service.</span></span> <span data-ttu-id="55c19-176">Cette implémentation fictive utilise un jeu de données codées en dur pour ses données, ce qui simplifie certaines tâches en supprimant la dépendance vis-à-vis du service catalog.api dans les environnements de développement.</span><span class="sxs-lookup"><span data-stu-id="55c19-176">This mock uses a hard-coded dataset for its data, which simplifies some tasks by removing the dependency on the catalog.api service in development environments.</span></span>

## <a name="lifting-and-shifting"></a><span data-ttu-id="55c19-177">Scénarios « lift-and-shift »</span><span class="sxs-lookup"><span data-stu-id="55c19-177">Lifting and shifting</span></span>

<span data-ttu-id="55c19-178">Visual Studio offre une excellent prise en charge de la mise en conteneur d’une application.</span><span class="sxs-lookup"><span data-stu-id="55c19-178">Visual Studio provides great support for containerizing an application.</span></span> <span data-ttu-id="55c19-179">Vous cliquez avec le bouton droit sur le nœud du projet, puis vous sélectionnez **Ajouter** et **Prise en charge de Docker**.</span><span class="sxs-lookup"><span data-stu-id="55c19-179">You right-click the project node and then select **Add** and **Docker Support**.</span></span> <span data-ttu-id="55c19-180">Le modèle de projet Docker ajoute un nouveau projet à la solution appelée **docker-compose**.</span><span class="sxs-lookup"><span data-stu-id="55c19-180">The Docker project template adds a new project to the solution called **docker-compose**.</span></span> <span data-ttu-id="55c19-181">Le projet contient les composants Docker qui constituent (ou génèrent) les images dont vous avez besoin, puis commence à exécuter les conteneurs nécessaires, comme indiqué dans la figure 7-3.</span><span class="sxs-lookup"><span data-stu-id="55c19-181">The project contains the Docker assets that compose (or build) the images you need, and starts running the necessary containers, as shown in Figure 7-3.</span></span>

<span data-ttu-id="55c19-182">Dans les scénarios « lift-and-shift »les plus simples, l’application est le seul service que vous utilisez pour l’application Web Forms.</span><span class="sxs-lookup"><span data-stu-id="55c19-182">In the simplest lift-and-shift scenarios, the application will be the single service that you use for the Web Forms application.</span></span> <span data-ttu-id="55c19-183">Le modèle change également votre projet de démarrage pour pointer vers le projet **docker-compose**.</span><span class="sxs-lookup"><span data-stu-id="55c19-183">The template also changes your startup project to point to the **docker-compose** project.</span></span> <span data-ttu-id="55c19-184">Appuyez maintenant sur Ctrl+F5 ou F5 pour créer l’image Docker et lancer le conteneur Docker.</span><span class="sxs-lookup"><span data-stu-id="55c19-184">Pressing Ctrl+F5 or F5 now creates the Docker image and launches the Docker container.</span></span>

![](./media/image3.png)

<span data-ttu-id="55c19-185">**Figure 7-3**.</span><span class="sxs-lookup"><span data-stu-id="55c19-185">**Figure 7-3**.</span></span> <span data-ttu-id="55c19-186">Projet **docker-compose** dans la solution Web Forms</span><span class="sxs-lookup"><span data-stu-id="55c19-186">The **docker-compose** project in the Web Forms solution</span></span>

<span data-ttu-id="55c19-187">Avant d’exécuter la solution, vous devez vérifier que vous configurez Docker pour utiliser des conteneurs Windows.</span><span class="sxs-lookup"><span data-stu-id="55c19-187">Before you run the solution, you must make sure that you configure Docker to use Windows Containers.</span></span> <span data-ttu-id="55c19-188">Pour ce faire, vous cliquez avec le bouton droit sur l’icône Docker située dans la barre des tâches Windows, puis vous sélectionnez **Basculer vers les conteneurs Windows**, comme illustré dans la figure 7-4.</span><span class="sxs-lookup"><span data-stu-id="55c19-188">To do that, you right-click the Docker taskbar icon in Windows and select **Switch to Windows Containers**, as shown in Figure 7-4.</span></span>

![](./media/image4.png)

<span data-ttu-id="55c19-189">**Figure 7-4**.</span><span class="sxs-lookup"><span data-stu-id="55c19-189">**Figure 7-4**.</span></span> <span data-ttu-id="55c19-190">Basculer vers les conteneurs Windows à partir de l’icône Docker située dans la barre des tâches Windows</span><span class="sxs-lookup"><span data-stu-id="55c19-190">Switching to Windows Containers from the Docker taskbar icon in Windows</span></span>

<span data-ttu-id="55c19-191">Si l’élément de menu indique **Basculer vers les conteneurs Linux**, vous exécutez déjà Docker avec des conteneurs Windows.</span><span class="sxs-lookup"><span data-stu-id="55c19-191">If the menu item says **Switch to Linux containers**, you are already running Docker with Windows Containers.</span></span>

<span data-ttu-id="55c19-192">L’exécution de la solution redémarre l’hôte Docker.</span><span class="sxs-lookup"><span data-stu-id="55c19-192">Running the solution restarts the Docker host.</span></span> <span data-ttu-id="55c19-193">Pendant la génération, vous générez l’application et l’image Docker du projet Web Forms.</span><span class="sxs-lookup"><span data-stu-id="55c19-193">When you build, you build the application and the Docker image for the Web Forms project.</span></span> <span data-ttu-id="55c19-194">Cette opération prend beaucoup de temps la première fois.</span><span class="sxs-lookup"><span data-stu-id="55c19-194">The first time you do this, it takes considerable time.</span></span> <span data-ttu-id="55c19-195">En effet, le processus de génération extrait l’image Windows Server de base et l’image supplémentaire pour ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="55c19-195">This is because the build process pulls down the base Windows Server image and the additional image for ASP.NET.</span></span> <span data-ttu-id="55c19-196">Les cycles de génération et d’exécution suivants sont beaucoup plus rapides.</span><span class="sxs-lookup"><span data-stu-id="55c19-196">Subsequent build and run cycles will be much faster.</span></span>

<span data-ttu-id="55c19-197">Jetons un œil sur les fichiers ajoutés par le modèle de projet Docker.</span><span class="sxs-lookup"><span data-stu-id="55c19-197">Let’s take a deeper look at the files added by the Docker project template.</span></span> <span data-ttu-id="55c19-198">Ce dernier a créé plusieurs fichiers pour vous.</span><span class="sxs-lookup"><span data-stu-id="55c19-198">It created several files for you.</span></span> <span data-ttu-id="55c19-199">Visual Studio utilise ces fichiers pour créer l’image Docker et lancer un conteneur.</span><span class="sxs-lookup"><span data-stu-id="55c19-199">Visual Studio uses these files to create the Docker image and launch a container.</span></span> <span data-ttu-id="55c19-200">Vous pouvez utiliser les mêmes fichiers à partir de l’interface CLI pour exécuter des commandes Docker manuellement.</span><span class="sxs-lookup"><span data-stu-id="55c19-200">You can use the same files from the CLI to run Docker commands manually.</span></span>

<span data-ttu-id="55c19-201">L’exemple de Dockerfile suivant montre les paramètres de base pour la génération d’une image Docker basée sur l’image Windows ASP.NET qui exécute un site ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="55c19-201">The following Dockerfile example shows the basic settings for building a Docker image based on the Windows ASP.NET image that runs an ASP.NET site.</span></span>

```
FROM microsoft/aspnet

ARG source

WORKDIR /inetpub/wwwroot

COPY ${source:-obj/Docker/publish} .
```

<span data-ttu-id="55c19-202">Ce Dockerfile ressemble de près à ceux créés pour l’exécution d’une application ASP.NET Core dans des conteneurs Linux.</span><span class="sxs-lookup"><span data-stu-id="55c19-202">This Dockerfile will look very similar to those created for running an ASP.NET Core application in Linux containers.</span></span> <span data-ttu-id="55c19-203">Toutefois, il existe des différences importantes.</span><span class="sxs-lookup"><span data-stu-id="55c19-203">However, there are a few important differences.</span></span> <span data-ttu-id="55c19-204">La principale différence est que l’image de base est microsoft/aspnet, à savoir l’image Windows Server actuelle qui inclut le .NET Framework.</span><span class="sxs-lookup"><span data-stu-id="55c19-204">The most important difference is that the base image is microsoft/aspnet, which is the current Windows Server image that includes the .NET Framework.</span></span> <span data-ttu-id="55c19-205">Les autres différences ont trait aux répertoires copiés à partir de votre répertoire source.</span><span class="sxs-lookup"><span data-stu-id="55c19-205">Other differences are that the directories copied from your source directory are different.</span></span>

<span data-ttu-id="55c19-206">Les autres fichiers du projet **docker-compose** correspondent aux composants Docker nécessaires pour générer et configurer les conteneurs.</span><span class="sxs-lookup"><span data-stu-id="55c19-206">The other files in the **docker-compose** project are the Docker assets needed to build and configure the containers.</span></span> <span data-ttu-id="55c19-207">Visual Studio place les divers fichiers docker-compose.yml sous un nœud unique pour mettre en évidence leur mode d’utilisation.</span><span class="sxs-lookup"><span data-stu-id="55c19-207">Visual Studio puts the various docker-compose.yml files under one node to highlight how they are used.</span></span> <span data-ttu-id="55c19-208">Le fichier docker-compose de base contient les directives communes à toutes les configurations.</span><span class="sxs-lookup"><span data-stu-id="55c19-208">The base docker-compose file contains the directives that are common to all configurations.</span></span> <span data-ttu-id="55c19-209">Le fichier docker-compose.override.yml contient des variables d’environnement et les remplacements associés d’une configuration de développeur.</span><span class="sxs-lookup"><span data-stu-id="55c19-209">The docker-compose.override.yml file contains environment variables and related overrides for a developer configuration.</span></span> <span data-ttu-id="55c19-210">Les variantes avec .vs.debug et .vs.release fournissent des paramètres d’environnement qui permettent à Visual Studio de s’attacher au conteneur en cours d’exécution et de le gérer.</span><span class="sxs-lookup"><span data-stu-id="55c19-210">The variants with .vs.debug and .vs.release provide environment settings that enable Visual Studio to attach to and manage the running container.</span></span>

<span data-ttu-id="55c19-211">Alors que l’intégration de Visual Studio fait partie de l’ajout de la prise en charge de Docker à votre solution, vous pouvez aussi générer et exécuter des commandes à partir de la ligne de commande, en utilisant la commande docker-compose up, comme vous l’avez vu dans les sections précédentes.</span><span class="sxs-lookup"><span data-stu-id="55c19-211">While Visual Studio integration is part of adding Docker support to your solution, you can also build and run from the command line, using the docker-compose up command, as you saw in previous sections.</span></span>

## <a name="getting-data-from-the-existing-catalog-net-core-microservice"></a><span data-ttu-id="55c19-212">Obtention de données à partir du microservice .NET Core du catalogue existant</span><span class="sxs-lookup"><span data-stu-id="55c19-212">Getting data from the existing catalog .NET Core microservice</span></span>

<span data-ttu-id="55c19-213">Vous pouvez configurer l’application Web Forms pour qu’elle utilise le microservice du catalogue eShopOnContainers afin d’obtenir des données au lieu d’utiliser des données fictives.</span><span class="sxs-lookup"><span data-stu-id="55c19-213">You can configure the Web Forms application to use the eShopOnContainers catalog microservice to get data instead of using fake data.</span></span> <span data-ttu-id="55c19-214">Pour cela, vous modifiez le fichier web.config et définissez la valeur de la clé useFake sur false.</span><span class="sxs-lookup"><span data-stu-id="55c19-214">To do this, you edit the web.config file and set the value of the useFake key to false.</span></span> <span data-ttu-id="55c19-215">Le conteneur d’injection de dépendance utilise la classe qui accède au microservice du catalogue en direct au lieu de la classe qui retourne les données codées en dur.</span><span class="sxs-lookup"><span data-stu-id="55c19-215">The DI container will use the class that accesses the live catalog microservice instead of the class that returns the hard-coded data.</span></span> <span data-ttu-id="55c19-216">Aucune autre modification de code n’est nécessaire.</span><span class="sxs-lookup"><span data-stu-id="55c19-216">No other code changes are needed.</span></span>

<span data-ttu-id="55c19-217">L’accès au service de catalogue en direct exige la mise à jour du projet **docker-compose** pour créer l’image du service de catalogue et lancer le conteneur du service de catalogue.</span><span class="sxs-lookup"><span data-stu-id="55c19-217">Accessing the live catalog service does mean you need to update the **docker-compose** project to build the catalog service image and launch the catalog service container.</span></span> <span data-ttu-id="55c19-218">Docker CE pour Windows prend à la fois en charge les conteneurs Linux et les conteneurs Windows, mais pas en même temps.</span><span class="sxs-lookup"><span data-stu-id="55c19-218">Docker CE for Windows supports both Linux containers and Windows Containers, but not at the same time.</span></span> <span data-ttu-id="55c19-219">Pour exécuter le microservice du catalogue, vous devez générer une image qui exécute le microservice du catalogue par-dessus un conteneur basé sur Windows.</span><span class="sxs-lookup"><span data-stu-id="55c19-219">To run the catalog microservice, you need to build an image that runs the catalog microservice on top of a Windows-based container.</span></span> <span data-ttu-id="55c19-220">Cette approche exige un autre Dockerfile pour le projet de microservices que vous avez vu dans les sections précédentes.</span><span class="sxs-lookup"><span data-stu-id="55c19-220">This approach requires a different Dockerfile for the microservices project than you have seen in earlier sections.</span></span> <span data-ttu-id="55c19-221">Le fichier Dockerfile.windows contient les paramètres de configuration requis pour générer l’image de conteneur de l’API de catalogue afin qu’elle s’exécute sur un conteneur Windows, par exemple, pour utiliser une image Docker Windows Nano.</span><span class="sxs-lookup"><span data-stu-id="55c19-221">The Dockerfile.windows file contains the configuration settings to build the catalog API container image so that it runs on a Windows container—for example, to use a Windows Nano Docker image.</span></span>

<span data-ttu-id="55c19-222">Le microservice du catalogue s’appuie sur la base de données SQL Server.</span><span class="sxs-lookup"><span data-stu-id="55c19-222">The catalog microservice relies on the SQL Server database.</span></span> <span data-ttu-id="55c19-223">Par conséquent, vous devez aussi utiliser une image Docker SQL Server basée sur Windows.</span><span class="sxs-lookup"><span data-stu-id="55c19-223">Therefore, you need to use a Windows-based SQL Server Docker image as well.</span></span>

<span data-ttu-id="55c19-224">Après ces modifications, le projet docker-compose fait plus de choses pour démarrer l’application.</span><span class="sxs-lookup"><span data-stu-id="55c19-224">After these changes, the docker-compose project does more to start the application.</span></span> <span data-ttu-id="55c19-225">Le projet démarre maintenant le serveur SQL Server à l’aide de l’image SQL Server basée sur Windows.</span><span class="sxs-lookup"><span data-stu-id="55c19-225">The project now starts the SQL Server using the Windows based SQL Server image.</span></span> <span data-ttu-id="55c19-226">Il démarre le microservice du catalogue dans un conteneur Windows.</span><span class="sxs-lookup"><span data-stu-id="55c19-226">It starts the catalog microservice in a Windows container.</span></span> <span data-ttu-id="55c19-227">Et il démarre également le conteneur de l’éditeur de catalogue Web Forms, également dans un conteneur Windows.</span><span class="sxs-lookup"><span data-stu-id="55c19-227">And it starts the Web Forms catalog editor container, also in a Windows container.</span></span> <span data-ttu-id="55c19-228">Si une des images a besoin d’être générée, les images sont d’abord créées.</span><span class="sxs-lookup"><span data-stu-id="55c19-228">If any of the images need building, the images are created first.</span></span>

## <a name="development-and-production-environments"></a><span data-ttu-id="55c19-229">Environnements de développement et de production</span><span class="sxs-lookup"><span data-stu-id="55c19-229">Development and production environments</span></span>

<span data-ttu-id="55c19-230">Il existe quelques différences entre la configuration de développement et une configuration de production.</span><span class="sxs-lookup"><span data-stu-id="55c19-230">There are a couple of differences between the development configuration and a production configuration.</span></span> <span data-ttu-id="55c19-231">Dans l’environnement de développement, vous exécutez l’application Web Forms, le microservice du catalogue et SQL Server dans des conteneurs Windows, dans le cadre du même hôte Docker.</span><span class="sxs-lookup"><span data-stu-id="55c19-231">In the development environment, you run the Web Forms application, the catalog microservice, and SQL Server in Windows Containers, as part of the same Docker host.</span></span> <span data-ttu-id="55c19-232">Dans les sections précédentes, nous avons mentionné les images SQL Server déployées dans le même hôte Docker que les autres services .NET Core sur un hôte Docker Linux.</span><span class="sxs-lookup"><span data-stu-id="55c19-232">In earlier sections, we mentioned SQL Server images deployed in the same Docker host as the other .NET Core-based services on a Linux-based Docker host.</span></span> <span data-ttu-id="55c19-233">L’avantage d’exécuter les multiples microservices dans le même hôte (ou cluster) Docker est qu’il y a moins de communication réseau et que la communication entre les conteneurs a une latence plus faible.</span><span class="sxs-lookup"><span data-stu-id="55c19-233">The advantage of running the multiple microservices in the same Docker host (or cluster) is that there is less network communication and the communication between containers has lower latency.</span></span>

<span data-ttu-id="55c19-234">Dans l’environnement de développement, vous devez exécuter tous les conteneurs dans le même système d’exploitation.</span><span class="sxs-lookup"><span data-stu-id="55c19-234">In the development environment, you must run all the containers in the same OS.</span></span> <span data-ttu-id="55c19-235">Docker CE pour Windows ne prend pas en charge l’exécution de conteneurs Windows et Linux en même temps.</span><span class="sxs-lookup"><span data-stu-id="55c19-235">Docker CE for Windows does not support running Windows- and Linux-based containers at the same time.</span></span> <span data-ttu-id="55c19-236">En production, vous pouvez décider si vous souhaitez exécuter le microservice du catalogue dans un conteneur Windows dans un seul hôte (ou cluster) Docker, ou si vous voulez que l’application Web Forms communique avec une instance du microservice du catalogue en cours d’exécution dans un conteneur Linux dans un autre hôte Docker.</span><span class="sxs-lookup"><span data-stu-id="55c19-236">In production, you can decide if you want to run the catalog microservice in a Windows container in a single Docker host (or cluster), or have the Web Forms application communicate with an instance of the catalog microservice running in a Linux container on a different Docker host.</span></span> <span data-ttu-id="55c19-237">Cette décision dépend de la façon dont vous voulez optimiser la latence du réseau.</span><span class="sxs-lookup"><span data-stu-id="55c19-237">It depends on how you want to optimize for network latency.</span></span> <span data-ttu-id="55c19-238">Dans la plupart des cas, il est souhaitable que les microservices dont dépendent vos applications s’exécutent dans le même hôte (ou essaim) Docker pour faciliter le déploiement et réduire la latence de communication.</span><span class="sxs-lookup"><span data-stu-id="55c19-238">In most cases, you want the microservices that your applications depend on running in the same Docker host (or swarm) for ease of deployment and lower communication latency.</span></span> <span data-ttu-id="55c19-239">Dans ces configurations, les seules communications coûteuses ont lieu entre les instances de microservice et les serveurs à haute disponibilité pour le stockage des données persistantes.</span><span class="sxs-lookup"><span data-stu-id="55c19-239">In those configurations, the only costly communications is between the microservice instances and the high-availability servers for the persistent data storage.</span></span>

>[!div class="step-by-step"]
<span data-ttu-id="55c19-240">[Précédent] (../net-core-single-containers-linux-windows-server-hosts/index.md) [Next] (../multi-container-microservice-net-applications/index.md)</span><span class="sxs-lookup"><span data-stu-id="55c19-240">[Previous] (../net-core-single-containers-linux-windows-server-hosts/index.md) [Next] (../multi-container-microservice-net-applications/index.md)</span></span>
