---
title: "Comment : écrire une boucle Parallel.For simple"
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-standard
ms.tgt_pltfrm: 
ms.topic: article
dev_langs:
- csharp
- vb
helpviewer_keywords:
- Parallel.For, How to Write
- for loop, parallel construction in .NET
- parallel for loops, how to use
ms.assetid: 9029ba7f-a9d1-4526-8c84-c88716dba5d4
caps.latest.revision: "18"
author: rpetrusha
ms.author: ronpet
manager: wpickett
ms.openlocfilehash: ed621f41e76addde777b974732470fcfbc903563
ms.sourcegitcommit: 4f3fef493080a43e70e951223894768d36ce430a
ms.translationtype: HT
ms.contentlocale: fr-FR
ms.lasthandoff: 11/21/2017
---
# <a name="how-to-write-a-simple-parallelfor-loop"></a><span data-ttu-id="906aa-102">Comment : écrire une boucle Parallel.For simple</span><span class="sxs-lookup"><span data-stu-id="906aa-102">How to: Write a Simple Parallel.For Loop</span></span>
<span data-ttu-id="906aa-103">Cette rubrique contient deux exemples qui illustrent la méthode <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="906aa-103">This topic contains two examples that illustrate the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="906aa-104">Le premier utilise la surcharge de méthode <xref:System.Threading.Tasks.Parallel.For%28System.Int64%2CSystem.Int64%2CSystem.Action%7BSystem.Int64%7D%29?displayProperty=nameWithType> et le second utilise la surcharge <xref:System.Threading.Tasks.Parallel.For%28System.Int32%2CSystem.Int32%2CSystem.Action%7BSystem.Int32%7D%29?displayProperty=nameWithType>, les deux surcharges les plus simples de la méthode <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="906aa-104">The first uses the <xref:System.Threading.Tasks.Parallel.For%28System.Int64%2CSystem.Int64%2CSystem.Action%7BSystem.Int64%7D%29?displayProperty=nameWithType> method overload, and the second uses the <xref:System.Threading.Tasks.Parallel.For%28System.Int32%2CSystem.Int32%2CSystem.Action%7BSystem.Int32%7D%29?displayProperty=nameWithType> overload, the two simplest overloads of the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="906aa-105">Vous pouvez utiliser ces deux surcharges de la méthode <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> quand vous n'avez pas besoin d'annuler la boucle, de sortir des itérations de boucle ou de maintenir un état de thread local.</span><span class="sxs-lookup"><span data-stu-id="906aa-105">You can use these two overloads of the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method when you do not need to cancel the loop, break out of the loop iterations, or maintain any thread-local state.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="906aa-106">Cette documentation utilise les expressions lambda pour définir les délégués de la bibliothèque parallèle de tâches.</span><span class="sxs-lookup"><span data-stu-id="906aa-106">This documentation uses lambda expressions to define delegates in TPL.</span></span> <span data-ttu-id="906aa-107">Si les expressions lambda en C# ou Visual Basic ne vous sont pas familières, consultez la page [Expressions lambda en PLINQ et dans la bibliothèque parallèle de tâches](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md).</span><span class="sxs-lookup"><span data-stu-id="906aa-107">If you are not familiar with lambda expressions in C# or Visual Basic, see [Lambda Expressions in PLINQ and TPL](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md).</span></span>  
  
 <span data-ttu-id="906aa-108">Le premier exemple calcule la taille des fichiers dans un répertoire unique.</span><span class="sxs-lookup"><span data-stu-id="906aa-108">The first example calculates the size of files in a single directory.</span></span> <span data-ttu-id="906aa-109">Le deuxième calcule le produit de deux matrices.</span><span class="sxs-lookup"><span data-stu-id="906aa-109">The second computes the product of two matrices.</span></span>  
  
## <a name="example"></a><span data-ttu-id="906aa-110">Exemple</span><span class="sxs-lookup"><span data-stu-id="906aa-110">Example</span></span>  
 <span data-ttu-id="906aa-111">Cet exemple est un utilitaire en ligne de commande simple qui calcule la taille totale des fichiers d'un répertoire.</span><span class="sxs-lookup"><span data-stu-id="906aa-111">This example is a simple command-line utility that calculates the total size of files in a directory.</span></span> <span data-ttu-id="906aa-112">Il attend un chemin d'accès de répertoire unique en tant qu'argument et indique le nombre et la taille totale des fichiers contenus dans ce répertoire.</span><span class="sxs-lookup"><span data-stu-id="906aa-112">It expects a single directory path as an argument, and reports the number and total size of the files in that directory.</span></span> <span data-ttu-id="906aa-113">Après avoir vérifié que le répertoire existe, il utilise la méthode <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> pour énumérer les fichiers dans le répertoire et déterminer leur taille.</span><span class="sxs-lookup"><span data-stu-id="906aa-113">After verifying that the directory exists, it uses the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method to enumerate the files in the directory and determine their file sizes.</span></span> <span data-ttu-id="906aa-114">Chaque taille de fichier est ensuite ajoutée à la variable `totalSize`.</span><span class="sxs-lookup"><span data-stu-id="906aa-114">Each file size is then added to the `totalSize` variable.</span></span> <span data-ttu-id="906aa-115">Notez que l'addition est effectuée en appelant la méthode <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType>, pour être exécutée comme une opération atomique.</span><span class="sxs-lookup"><span data-stu-id="906aa-115">Note that the addition is performed by calling the <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType> so that the addition is performed as an atomic operation.</span></span> <span data-ttu-id="906aa-116">Dans le cas contraire, plusieurs tâches pourraient essayer de mettre à jour la variable `totalSize` simultanément.</span><span class="sxs-lookup"><span data-stu-id="906aa-116">Otherwise, multiple tasks could try to update the `totalSize` variable simultaneously.</span></span>  
  
 [!code-csharp[Conceptual.Parallel.For#1](../../../samples/snippets/csharp/VS_Snippets_CLR/conceptual.parallel.for/cs/for1.cs#1)]
 [!code-vb[Conceptual.Parallel.For#1](../../../samples/snippets/visualbasic/VS_Snippets_CLR/conceptual.parallel.for/vb/for1.vb#1)]  
  
## <a name="example"></a><span data-ttu-id="906aa-117">Exemple</span><span class="sxs-lookup"><span data-stu-id="906aa-117">Example</span></span>  
 <span data-ttu-id="906aa-118">Cet exemple utilise la méthode <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> pour calculer le produit de deux matrices.</span><span class="sxs-lookup"><span data-stu-id="906aa-118">This example uses the <xref:System.Threading.Tasks.Parallel.For%2A?displayProperty=nameWithType> method to compute the product of two matrices.</span></span> <span data-ttu-id="906aa-119">Il montre également comment utiliser la classe <xref:System.Diagnostics.Stopwatch?displayProperty=nameWithType> pour comparer les performances d'une boucle parallèle avec une boucle non parallèle.</span><span class="sxs-lookup"><span data-stu-id="906aa-119">It also shows how to use the <xref:System.Diagnostics.Stopwatch?displayProperty=nameWithType> class to compare the performance of a parallel loop with a non-parallel loop.</span></span> <span data-ttu-id="906aa-120">Étant donné qu'il peut générer un important volume de sortie, l'exemple permet de rediriger la sortie vers un fichier.</span><span class="sxs-lookup"><span data-stu-id="906aa-120">Note that, because it can generate a large volume of output, the example allows output to be redirected to a file.</span></span>  
  
 [!code-csharp[TPL_Parallel#01](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/simpleparallelfor.cs#01)]
 [!code-vb[TPL_Parallel#01](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/simpleparallelfor.vb#01)]  
  
 <span data-ttu-id="906aa-121">Lors de la parallélisation du code, y compris des boucles, un objectif important consiste à utiliser les processeurs le plus possible sans surparalléliser jusqu'au point où la surcharge de traitement en parallèle réduit les performances.</span><span class="sxs-lookup"><span data-stu-id="906aa-121">When parallelizing any code, including loops, one important goal is to utilize the processors as much as possible without over parallelizing to the point where the overhead for parallel processing negates any performance benefits.</span></span> <span data-ttu-id="906aa-122">Dans cet exemple, seule la boucle externe est parallélisée, car peu de travail est effectué dans la boucle interne.</span><span class="sxs-lookup"><span data-stu-id="906aa-122">In this particular example, only the outer loop is parallelized because there is not very much work performed in the inner loop.</span></span> <span data-ttu-id="906aa-123">La combinaison d'une petite quantité de travail et des effets indésirables du cache peut entraîner une dégradation des performances dans les boucles parallèles imbriquées.</span><span class="sxs-lookup"><span data-stu-id="906aa-123">The combination of a small amount of work and undesirable cache effects can result in performance degradation in nested parallel loops.</span></span> <span data-ttu-id="906aa-124">Par conséquent, paralléliser uniquement la boucle externe est la meilleure façon d'optimiser les avantages offerts par l'accès concurrentiel sur la plupart des systèmes.</span><span class="sxs-lookup"><span data-stu-id="906aa-124">Therefore, parallelizing the outer loop only is the best way to maximize the benefits of concurrency on most systems.</span></span>  
  
## <a name="the-delegate"></a><span data-ttu-id="906aa-125">Délégué</span><span class="sxs-lookup"><span data-stu-id="906aa-125">The Delegate</span></span>  
 <span data-ttu-id="906aa-126">Le troisième paramètre de cette surcharge de <xref:System.Threading.Tasks.Parallel.For%2A> est un délégué de type `Action<int>` en C# ou `Action(Of Integer)` en Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="906aa-126">The third parameter of this overload of <xref:System.Threading.Tasks.Parallel.For%2A> is a delegate of type `Action<int>` in C# or `Action(Of Integer)` in Visual Basic.</span></span> <span data-ttu-id="906aa-127">Un délégué `Action`, qu'il possède zéro, un ou seize paramètres de type, retourne toujours void.</span><span class="sxs-lookup"><span data-stu-id="906aa-127">An `Action` delegate, whether it has zero, one or sixteen type parameters, always returns void.</span></span> <span data-ttu-id="906aa-128">En Visual Basic, le comportement d'une `Action` est défini avec un `Sub`.</span><span class="sxs-lookup"><span data-stu-id="906aa-128">In Visual Basic, the behavior of an `Action` is defined with a `Sub`.</span></span> <span data-ttu-id="906aa-129">L’exemple utilise une expression lambda pour créer le délégué, mais vous pouvez le créer d’autres façons.</span><span class="sxs-lookup"><span data-stu-id="906aa-129">The example uses a lambda expression to create the delegate, but you can create the delegate in other ways as well.</span></span> <span data-ttu-id="906aa-130">Pour plus d’informations, consultez [Expressions Lambda en PLINQ et la bibliothèque parallèle de tâches](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md).</span><span class="sxs-lookup"><span data-stu-id="906aa-130">For more information, see [Lambda Expressions in PLINQ and TPL](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md).</span></span>  
  
## <a name="the-iteration-value"></a><span data-ttu-id="906aa-131">Valeur d'itération</span><span class="sxs-lookup"><span data-stu-id="906aa-131">The Iteration Value</span></span>  
 <span data-ttu-id="906aa-132">Le délégué accepte un seul paramètre d'entrée dont la valeur est l'itération actuelle.</span><span class="sxs-lookup"><span data-stu-id="906aa-132">The delegate takes a single input parameter whose value is the current iteration.</span></span> <span data-ttu-id="906aa-133">Cette valeur d'itération est fournie par le runtime et sa valeur de départ est l'index du premier élément du segment (partition) de la source qui est en cours de traitement sur le thread actuel.</span><span class="sxs-lookup"><span data-stu-id="906aa-133">This iteration value is supplied by the runtime and its starting value is the index of the first element on the segment (partition) of the source that is being processed on the current thread.</span></span>  
  
 <span data-ttu-id="906aa-134">Si vous souhaitez contrôler plus étroitement le niveau d'accès concurrentiel, utilisez l'une des surcharges qui acceptent un paramètre d'entrée <xref:System.Threading.Tasks.ParallelOptions?displayProperty=nameWithType>, telles que : <xref:System.Threading.Tasks.Parallel.For%28System.Int32%2CSystem.Int32%2CSystem.Threading.Tasks.ParallelOptions%2CSystem.Action%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%7D%29?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="906aa-134">If you require more control over the concurrency level, use one of the overloads that takes a <xref:System.Threading.Tasks.ParallelOptions?displayProperty=nameWithType> input parameter, such as: <xref:System.Threading.Tasks.Parallel.For%28System.Int32%2CSystem.Int32%2CSystem.Threading.Tasks.ParallelOptions%2CSystem.Action%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%7D%29?displayProperty=nameWithType>.</span></span>  
  
## <a name="return-value-and-exception-handling"></a><span data-ttu-id="906aa-135">Valeur de retour et gestion des exceptions</span><span class="sxs-lookup"><span data-stu-id="906aa-135">Return Value and Exception Handling</span></span>  
 <span data-ttu-id="906aa-136"><xref:System.Threading.Tasks.Parallel.For%2A> retourne un objet <xref:System.Threading.Tasks.ParallelLoopResult?displayProperty=nameWithType> quand tous les threads sont terminés.</span><span class="sxs-lookup"><span data-stu-id="906aa-136"><xref:System.Threading.Tasks.Parallel.For%2A> returns a <xref:System.Threading.Tasks.ParallelLoopResult?displayProperty=nameWithType> object when all threads have completed.</span></span> <span data-ttu-id="906aa-137">Cette valeur de retour est utile quand vous arrêtez ou rompez l'itération de boucle manuellement, car le <xref:System.Threading.Tasks.ParallelLoopResult> stocke des informations telles que la dernière itération qui s'est achevée.</span><span class="sxs-lookup"><span data-stu-id="906aa-137">This return value is useful when you are stopping or breaking loop iteration manually, because the <xref:System.Threading.Tasks.ParallelLoopResult> stores information such as the last iteration that ran to completion.</span></span> <span data-ttu-id="906aa-138">Si une ou plusieurs exceptions se produisent sur l'un des threads, une <xref:System.AggregateException?displayProperty=nameWithType> est levée.</span><span class="sxs-lookup"><span data-stu-id="906aa-138">If one or more exceptions occur on one of the threads, a <xref:System.AggregateException?displayProperty=nameWithType> will be thrown.</span></span>  
  
 <span data-ttu-id="906aa-139">Dans le code de cet exemple, la valeur de retour de <xref:System.Threading.Tasks.Parallel.For%2A> n'est pas utilisée.</span><span class="sxs-lookup"><span data-stu-id="906aa-139">In the code in this example, the return value of <xref:System.Threading.Tasks.Parallel.For%2A> is not used.</span></span>  
  
## <a name="analysis-and-performance"></a><span data-ttu-id="906aa-140">Analyse et performances</span><span class="sxs-lookup"><span data-stu-id="906aa-140">Analysis and Performance</span></span>  
 <span data-ttu-id="906aa-141">Vous pouvez utiliser l'Assistant Performance pour afficher l'utilisation du processeur sur votre ordinateur.</span><span class="sxs-lookup"><span data-stu-id="906aa-141">You can use the Performance Wizard to view CPU usage on your computer.</span></span> <span data-ttu-id="906aa-142">À des fins de test, augmentez le nombre de colonnes et de lignes des matrices.</span><span class="sxs-lookup"><span data-stu-id="906aa-142">As an experiment, increase the number of columns and rows in the matrices.</span></span> <span data-ttu-id="906aa-143">Plus les matrices sont grandes, plus la différence de performances est élevée entre les versions parallèles et séquentielles du calcul.</span><span class="sxs-lookup"><span data-stu-id="906aa-143">The larger the matrices, the greater the performance difference between the parallel and sequential versions of the computation.</span></span> <span data-ttu-id="906aa-144">Quand la matrice est petite, la version séquentielle s'exécute plus rapidement en raison de la surcharge liée au paramétrage de la boucle parallèle.</span><span class="sxs-lookup"><span data-stu-id="906aa-144">When the matrix is small, the sequential version will run faster because of the overhead in setting up the parallel loop.</span></span>  
  
 <span data-ttu-id="906aa-145">Les appels synchrones aux ressources partagées, telles que la console ou le système de fichiers, entraînent une dégradation sensible des performances d'une boucle parallèle.</span><span class="sxs-lookup"><span data-stu-id="906aa-145">Synchronous calls to shared resources, like the Console or the File System, will significantly degrade the performance of a parallel loop.</span></span> <span data-ttu-id="906aa-146">Quand vous mesurez les performances, essayez d'éviter les appels tels que <xref:System.Console.WriteLine%2A?displayProperty=nameWithType> dans la boucle.</span><span class="sxs-lookup"><span data-stu-id="906aa-146">When measuring performance, try to avoid calls such as <xref:System.Console.WriteLine%2A?displayProperty=nameWithType> within the loop.</span></span>  
  
## <a name="compiling-the-code"></a><span data-ttu-id="906aa-147">Compilation du code</span><span class="sxs-lookup"><span data-stu-id="906aa-147">Compiling the Code</span></span>  
  
-   <span data-ttu-id="906aa-148">Copiez et collez ce code dans un projet Visual Studio 2010.</span><span class="sxs-lookup"><span data-stu-id="906aa-148">Copy and paste this code into a Visual Studio 2010 project.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="906aa-149">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="906aa-149">See Also</span></span>  
 <xref:System.Threading.Tasks.Parallel.For%2A>  
 <xref:System.Threading.Tasks.Parallel.ForEach%2A>  
 [<span data-ttu-id="906aa-150">Parallélisme de données</span><span class="sxs-lookup"><span data-stu-id="906aa-150">Data Parallelism</span></span>](../../../docs/standard/parallel-programming/data-parallelism-task-parallel-library.md)  
 [<span data-ttu-id="906aa-151">Programmation parallèle</span><span class="sxs-lookup"><span data-stu-id="906aa-151">Parallel Programming</span></span>](../../../docs/standard/parallel-programming/index.md)
