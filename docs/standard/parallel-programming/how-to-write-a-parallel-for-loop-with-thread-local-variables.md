---
title: "Comment : écrire une boucle Parallel.For avec des variables locales de thread"
ms.custom: 
ms.date: 03/30/2017
ms.prod: .net
ms.reviewer: 
ms.suite: 
ms.technology: dotnet-standard
ms.tgt_pltfrm: 
ms.topic: article
dev_langs:
- csharp
- vb
helpviewer_keywords: parallel for loops, how to use local state
ms.assetid: 68384064-7ee7-41e2-90e3-71f00bde01bb
caps.latest.revision: "23"
author: rpetrusha
ms.author: ronpet
manager: wpickett
ms.openlocfilehash: 2e0b3e28c95d9ccfb0ecd1954e16960576d8f115
ms.sourcegitcommit: 4f3fef493080a43e70e951223894768d36ce430a
ms.translationtype: HT
ms.contentlocale: fr-FR
ms.lasthandoff: 11/21/2017
---
# <a name="how-to-write-a-parallelfor-loop-with-thread-local-variables"></a><span data-ttu-id="1a1fc-102">Comment : écrire une boucle Parallel.For avec des variables locales de thread</span><span class="sxs-lookup"><span data-stu-id="1a1fc-102">How to: Write a Parallel.For Loop with Thread-Local Variables</span></span>
<span data-ttu-id="1a1fc-103">Cet exemple montre comment utiliser des variables de thread local pour stocker et récupérer l'état de chaque tâche créée par une boucle <xref:System.Threading.Tasks.Parallel.For%2A>.</span><span class="sxs-lookup"><span data-stu-id="1a1fc-103">This example shows how to use thread-local variables to store and retrieve state in each separate task that is created by a <xref:System.Threading.Tasks.Parallel.For%2A> loop.</span></span> <span data-ttu-id="1a1fc-104">En utilisant des données de thread local, vous pouvez éviter la surcharge liée à la synchronisation d'un grand nombre d'accès à un état partagé.</span><span class="sxs-lookup"><span data-stu-id="1a1fc-104">By using thread-local data, you can avoid the overhead of synchronizing a large number of accesses to shared state.</span></span> <span data-ttu-id="1a1fc-105">Au lieu d'écrire dans une ressource partagée à chaque itération, vous calculez et stockez la valeur jusqu'à ce que toutes les itérations de la tâche soient terminées.</span><span class="sxs-lookup"><span data-stu-id="1a1fc-105">Instead of writing to a shared resource on each iteration, you compute and store the value until all iterations for the task are complete.</span></span> <span data-ttu-id="1a1fc-106">Vous pouvez ensuite écrire une fois le résultat final dans la ressource partagée ou le transmettre à une autre méthode.</span><span class="sxs-lookup"><span data-stu-id="1a1fc-106">You can then write the final result once to the shared resource, or pass it to another method.</span></span>  
  
## <a name="example"></a><span data-ttu-id="1a1fc-107">Exemple</span><span class="sxs-lookup"><span data-stu-id="1a1fc-107">Example</span></span>  
 <span data-ttu-id="1a1fc-108">L'exemple suivant appelle la méthode <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> pour calculer la somme des valeurs d'un tableau qui contient un million d'éléments.</span><span class="sxs-lookup"><span data-stu-id="1a1fc-108">The following example calls the <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method to calculate the sum of the values in an array that contains one million elements.</span></span> <span data-ttu-id="1a1fc-109">La valeur de chaque élément est égale à son index.</span><span class="sxs-lookup"><span data-stu-id="1a1fc-109">The value of each element is equal to its index.</span></span>  
  
 [!code-csharp[TPL_Parallel#05](../../../samples/snippets/csharp/VS_Snippets_Misc/tpl_parallel/cs/forandforeach_simple.cs#05)]
 [!code-vb[TPL_Parallel#05](../../../samples/snippets/visualbasic/VS_Snippets_Misc/tpl_parallel/vb/forwiththreadlocal.vb#05)]  
  
 <span data-ttu-id="1a1fc-110">Les deux premiers paramètres de chaque méthode <xref:System.Threading.Tasks.Parallel.For%2A> spécifient les valeurs d'itération initiale et finale.</span><span class="sxs-lookup"><span data-stu-id="1a1fc-110">The first two parameters of every <xref:System.Threading.Tasks.Parallel.For%2A> method specify the beginning and ending iteration values.</span></span> <span data-ttu-id="1a1fc-111">Dans cette surcharge de la méthode, le troisième paramètre indique où vous initialisez votre état local.</span><span class="sxs-lookup"><span data-stu-id="1a1fc-111">In this overload of the method, the third parameter is where you initialize your local state.</span></span> <span data-ttu-id="1a1fc-112">Dans ce contexte, « état local » signifie une variable dont la durée de vie commence juste avant la première itération de la boucle sur le thread actuel et se termine juste après la dernière itération.</span><span class="sxs-lookup"><span data-stu-id="1a1fc-112">In this context, local state means a variable whose lifetime extends from just before the first iteration of the loop on the current thread, to just after the last iteration.</span></span>  
  
 <span data-ttu-id="1a1fc-113">Le type du troisième paramètre est un délégué <xref:System.Func%601> où `TResult` représente le type de la variable destinée à stocker l'état de thread local.</span><span class="sxs-lookup"><span data-stu-id="1a1fc-113">The type of the third parameter is a <xref:System.Func%601> where `TResult` is the type of the variable that will store the thread-local state.</span></span> <span data-ttu-id="1a1fc-114">Son type est défini par l'argument de type générique fourni au moment de l'appel de la méthode <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> générique, en l'occurrence <xref:System.Int64>.</span><span class="sxs-lookup"><span data-stu-id="1a1fc-114">Its type is defined by the generic type argument supplied when calling the generic <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method, which in this case is <xref:System.Int64>.</span></span> <span data-ttu-id="1a1fc-115">L'argument de type indique au compilateur le type de la variable temporaire à utiliser pour stocker l'état de thread local.</span><span class="sxs-lookup"><span data-stu-id="1a1fc-115">The type argument tells the compiler the type of the temporary variable that will be used to store the thread-local state.</span></span> <span data-ttu-id="1a1fc-116">Dans cet exemple, l'expression `() => 0` (ou `Function() 0` dans Visual Basic) initialise la variable de thread local à zéro.</span><span class="sxs-lookup"><span data-stu-id="1a1fc-116">In this example, the expression `() => 0` (or `Function() 0` in Visual Basic) initializes the thread-local variable to zero.</span></span> <span data-ttu-id="1a1fc-117">Si l'argument de type générique est un type de référence ou un type de valeur défini par l'utilisateur, l'expression ressemble à ceci :</span><span class="sxs-lookup"><span data-stu-id="1a1fc-117">If the generic type argument is a reference type or user-defined value type, the expression would look like this:</span></span>  
  
```csharp  
() => new MyClass()  
```  
  
```vb  
Function() new MyClass()  
```  
  
 <span data-ttu-id="1a1fc-118">Le quatrième paramètre définit la logique de la boucle.</span><span class="sxs-lookup"><span data-stu-id="1a1fc-118">The fourth parameter defines the loop logic.</span></span> <span data-ttu-id="1a1fc-119">Il doit correspondre à un délégué ou à une expression lambda dont la signature est `Func<int, ParallelLoopState, long, long>` en C# ou `Func(Of Integer, ParallelLoopState, Long, Long)` en Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="1a1fc-119">It must be a delegate or lambda expression whose signature is `Func<int, ParallelLoopState, long, long>` in C# or `Func(Of Integer, ParallelLoopState, Long, Long)` in Visual Basic.</span></span> <span data-ttu-id="1a1fc-120">Le premier paramètre est la valeur du compteur de boucle pour cette itération de la boucle.</span><span class="sxs-lookup"><span data-stu-id="1a1fc-120">The first parameter is the value of the loop counter for that iteration of the loop.</span></span> <span data-ttu-id="1a1fc-121">Le deuxième est un objet <xref:System.Threading.Tasks.ParallelLoopState> qui permet de quitter la boucle ; cet objet est fourni par la classe <xref:System.Threading.Tasks.Parallel> à chaque occurrence de la boucle.</span><span class="sxs-lookup"><span data-stu-id="1a1fc-121">The second is a <xref:System.Threading.Tasks.ParallelLoopState> object that can be used to break out of the loop; this object is provided by the <xref:System.Threading.Tasks.Parallel> class to each occurrence of the loop.</span></span> <span data-ttu-id="1a1fc-122">Le troisième paramètre est la variable de thread local.</span><span class="sxs-lookup"><span data-stu-id="1a1fc-122">The third parameter is the thread-local variable.</span></span> <span data-ttu-id="1a1fc-123">Le dernier paramètre est le type de retour.</span><span class="sxs-lookup"><span data-stu-id="1a1fc-123">The last parameter is the return type.</span></span> <span data-ttu-id="1a1fc-124">Dans ce cas, le type est <xref:System.Int64>, car c'est ce type que nous avons spécifié dans l'argument de type <xref:System.Threading.Tasks.Parallel.For%2A>.</span><span class="sxs-lookup"><span data-stu-id="1a1fc-124">In this case, the type is <xref:System.Int64> because that is the type we specified in the <xref:System.Threading.Tasks.Parallel.For%2A> type argument.</span></span> <span data-ttu-id="1a1fc-125">Cette variable est nommée `subtotal` et est retournée par l'expression lambda.</span><span class="sxs-lookup"><span data-stu-id="1a1fc-125">That variable is named `subtotal` and is returned by the lambda expression.</span></span> <span data-ttu-id="1a1fc-126">La valeur de retour est utilisée pour initialiser `subtotal` à chaque itération suivante de la boucle.</span><span class="sxs-lookup"><span data-stu-id="1a1fc-126">The return value is used to initialize `subtotal` on each subsequent iteration of the loop.</span></span> <span data-ttu-id="1a1fc-127">Vous pouvez également considérer ce dernier paramètre comme une valeur transmise à chaque itération, puis communiquée au délégué `localFinally` quand la dernière itération est terminée.</span><span class="sxs-lookup"><span data-stu-id="1a1fc-127">You can also think of this last parameter as a value that is passed to each iteration, and then passed to the `localFinally` delegate when the last iteration is complete.</span></span>  
  
 <span data-ttu-id="1a1fc-128">Le cinquième paramètre définit la méthode qui est appelée une fois, après la fin de toutes les itérations sur un thread particulier.</span><span class="sxs-lookup"><span data-stu-id="1a1fc-128">The fifth parameter defines the method that is called once, after all the iterations on a particular thread have completed.</span></span> <span data-ttu-id="1a1fc-129">Le type de l'argument d'entrée correspond de nouveau à l'argument de type de la méthode <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> et au type retourné par l'expression lambda du corps.</span><span class="sxs-lookup"><span data-stu-id="1a1fc-129">The type of the input argument again corresponds to the type argument of the <xref:System.Threading.Tasks.Parallel.For%60%601%28System.Int32%2CSystem.Int32%2CSystem.Func%7B%60%600%7D%2CSystem.Func%7BSystem.Int32%2CSystem.Threading.Tasks.ParallelLoopState%2C%60%600%2C%60%600%7D%2CSystem.Action%7B%60%600%7D%29> method and the type returned by the body lambda expression.</span></span> <span data-ttu-id="1a1fc-130">Dans cet exemple, la valeur est ajoutée à une variable à portée de classe d'une façon thread-safe en appelant la méthode <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="1a1fc-130">In this example, the value is added to a variable at class scope in a thread safe way by calling the <xref:System.Threading.Interlocked.Add%2A?displayProperty=nameWithType> method.</span></span> <span data-ttu-id="1a1fc-131">L'utilisation d'une variable de thread local nous a évité d'écrire dans cette variable de classe à chaque itération de la boucle.</span><span class="sxs-lookup"><span data-stu-id="1a1fc-131">By using a thread-local variable, we have avoided writing to this class variable on every iteration of the loop.</span></span>  
  
 <span data-ttu-id="1a1fc-132">Pour plus d’informations sur l’utilisation d’expressions lambda, consultez [Expressions Lambda en PLINQ et la bibliothèque parallèle de tâches](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md).</span><span class="sxs-lookup"><span data-stu-id="1a1fc-132">For more information about how to use lambda expressions, see [Lambda Expressions in PLINQ and TPL](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="1a1fc-133">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="1a1fc-133">See Also</span></span>  
 [<span data-ttu-id="1a1fc-134">Parallélisme de données</span><span class="sxs-lookup"><span data-stu-id="1a1fc-134">Data Parallelism</span></span>](../../../docs/standard/parallel-programming/data-parallelism-task-parallel-library.md)  
 [<span data-ttu-id="1a1fc-135">Programmation parallèle</span><span class="sxs-lookup"><span data-stu-id="1a1fc-135">Parallel Programming</span></span>](../../../docs/standard/parallel-programming/index.md)  
 [<span data-ttu-id="1a1fc-136">La bibliothèque parallèle de tâches</span><span class="sxs-lookup"><span data-stu-id="1a1fc-136">Task Parallel Library (TPL)</span></span>](../../../docs/standard/parallel-programming/task-parallel-library-tpl.md)  
 [<span data-ttu-id="1a1fc-137">Expressions lambda en PLINQ et dans la bibliothèque parallèle de tâches</span><span class="sxs-lookup"><span data-stu-id="1a1fc-137">Lambda Expressions in PLINQ and TPL</span></span>](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md)
